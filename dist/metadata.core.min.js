/*!
 metadata.js v0.12.231, built:2017-06-26 &copy; Evgeniy Malyarov http://www.oknosoft.ru 2014-2017
 metadata.js may be freely distributed under the MIT. To obtain _Oknosoft Commercial license_, contact info@oknosoft.ru
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.$p=t()}(this,function(){function e(){this.__define({version:{value:"0.12.231",writable:!1},toString:{value:function(){return"Oknosoft data engine. v:"+this.version},writable:!1},utils:{value:new t},injected_data:{value:{},writable:!1},ajax:{value:new n,writable:!1},msg:{value:new a,writable:!1},wsql:{value:new r,writable:!1},eve:{value:new M,writable:!1},aes:{value:new I("metadata.js"),writable:!1},moment:{get:function(){return this.utils.moment}},_patch:{value:function(e,t){for(var n in t)"object"==typeof t[n]&&e[n]&&"object"==typeof e[n]?K._patch(e[n],t[n]):e[n]=t[n];return e}},_find:{value:function(e,t,n){var r,a,i;if("object"!=typeof t)for(a in e){r=e[a];for(var o in r)if("function"!=typeof r[o]&&K.utils.is_equal(r[o],t))return r}else for(a in e){r=e[a],i=!0;for(var o in t)if("function"!=typeof r[o]&&!K.utils.is_equal(r[o],t[o])){i=!1;break}if(i)return r}}},_selection:{value:function(e,t){var n,r,a,i=!0;if(t)if("function"==typeof t)i=t.call(this,e);else for(n in t)if(r=t[n],a=r&&"object"==typeof r,"_"!=n.substr(0,1))if("function"==typeof r){if(!(i=r.call(this,e,n)))break}else if("or"==n&&Array.isArray(r)){if(!(i=r.some(function(t){var n=Object.keys(t)[0];return t[n].hasOwnProperty("like")?"string"==typeof e[n]&&-1!=e[n].toLowerCase().indexOf(t[n].like.toLowerCase()):K.utils.is_equal(e[n],t[n])})))break}else if(a&&r.hasOwnProperty("like")){if(!e[n]||-1==e[n].toLowerCase().indexOf(r.like.toLowerCase())){i=!1;break}}else if(a&&r.hasOwnProperty("not")){if(K.utils.is_equal(e[n],r.not)){i=!1;break}}else if(a&&r.hasOwnProperty("in")){if(!(i=r.in.some(function(t){return K.utils.is_equal(t,e[n])})))break}else if(a&&r.hasOwnProperty("lt")){if(!(i=e[n]<r.lt))break}else if(a&&r.hasOwnProperty("gt")){if(!(i=e[n]>r.gt))break}else if(a&&r.hasOwnProperty("between")){var o=e[n];if("number"!=typeof o&&(o=K.utils.fix_date(e[n])),!(i=o>=r.between[0]&&o<=r.between[1]))break}else if(!K.utils.is_equal(e[n],r)){i=!1;break}return i}},_find_rows:{value:function(e,t,n){var r,a,i=[],o=0;t&&(t._top?(a=t._top,delete t._top):a=1e3);for(var s in e)if(r=e[s],K._selection.call(this,r,t)){if(n){if(!1===n.call(this,r))break}else i.push(r);if(a&&++o>=a)break}return i}},on:{value:function(e,t){if("object"!=typeof e)return this.eve.attachEvent(e,t);for(var n in e)e[n]._evnts||(e[n]._evnts=[]),e[n]._evnts.push(this.eve.attachEvent(n,e[n]))}},off:{value:function(e){2==arguments.length&&(e=arguments[1]),"function"==typeof e&&e._evnts?e._evnts.forEach(function(e){K.eve.detachEvent(e)}):e?K.eve.detachEvent(e):K.eve.detachAllEvents()}},record_log:{value:function(e){K.ireg&&K.ireg.log&&K.ireg.log.record(e)}},md:{value:new o},enm:{value:new function(){this.toString=function(){return K.msg.meta_enn_mgr}}},cat:{value:new function(){this.toString=function(){return K.msg.meta_cat_mgr}}},doc:{value:new function(){this.toString=function(){return K.msg.meta_doc_mgr}}},ireg:{value:new function(){this.toString=function(){return K.msg.meta_ireg_mgr}}},areg:{value:new function(){this.toString=function(){return K.msg.meta_areg_mgr}}},accreg:{value:new function(){this.toString=function(){return K.msg.meta_accreg_mgr}}},dp:{value:new function(){this.toString=function(){return K.msg.meta_dp_mgr}}},rep:{value:new function(){this.toString=function(){return K.msg.meta_reports_mgr}}},cacc:{value:new function(){this.toString=function(){return K.msg.meta_cacc_mgr}}},cch:{value:new function(){this.toString=function(){return K.msg.meta_cch_mgr}}},tsk:{value:new function(){this.toString=function(){return K.msg.meta_task_mgr}}},bp:{value:new function(){this.toString=function(){return K.msg.meta_bp_mgr}}},DataManager:{value:s},RefDataManager:{value:l},DataProcessorsManager:{value:u},EnumManager:{value:_},RegisterManager:{value:c},InfoRegManager:{value:f},LogManager:{value:v},MetaObjManager:{value:w},MetaFieldManager:{value:x},SchemeSettingsManager:{value:j},AccumRegManager:{value:d},CatManager:{value:p},ChartOfCharacteristicManager:{value:h},ChartOfAccountManager:{value:m},DocManager:{value:y},TaskManager:{value:g},BusinessProcessManager:{value:b},DataObj:{value:E},CatObj:{value:q},DocObj:{value:A},DataProcessorObj:{value:P},TaskObj:{value:R},BusinessProcessObj:{value:S},EnumObj:{value:N},RegisterRow:{value:C},TabularSection:{value:O},TabularSectionRow:{value:k}})}function t(){this.moment="function"==typeof moment?moment:require("moment"),this.moment._masks={date:"DD.MM.YY",date_time:"DD.MM.YYYY HH:mm",ldt:"DD MMMM YYYY, HH:mm",iso:"YYYY-MM-DDTHH:mm:ss"},this.fix_date=function(e,t){if(e instanceof Date)return e;var n=this.moment(e,["DD-MM-YYYY","DD-MM-YYYY HH:mm","DD-MM-YYYY HH:mm:ss","DD-MM-YY HH:mm","YYYYDDMMHHmmss",this.moment.ISO_8601]);return n.isValid()?n.toDate():t?this.blank.date:e},this.fix_guid=function(e,t){if(e&&"string"==typeof e);else{if(e instanceof E)return e.ref;if(e&&"object"==typeof e)if(e.presentation){if(e.ref)return e.ref;if(e.name)return e.name}else e="object"==typeof e.ref&&e.ref.hasOwnProperty("ref")?e.ref.ref:e.ref}return this.is_guid(e)||!1===t?e:t?this.generate_guid():this.blank.guid},this.fix_number=function(e,t){var n=parseFloat(e);return isNaN(n)?t?0:e:n},this.fix_boolean=function(e){return"string"==typeof e?!(!e||"false"==e.toLowerCase()):!!e},this.blank={date:this.fix_date("0001-01-01T00:00:00"),guid:"00000000-0000-0000-0000-000000000000",by_type:function(e){return e.is_ref?this.guid:e.date_part?this.date:e.digits?0:(!e.types||"boolean"!=e.types[0])&&""}},this.fetch_type=function(e,t){return t.is_ref?this.fix_guid(e):t.date_part?this.fix_date(e,!0):t.digits?this.fix_number(e,!0):t.types&&"boolean"==t.types[0]?this.fix_boolean(e):e},this.date_add_day=function(e,t,n){var r=new Date(e);return r.setDate(e.getDate()+t),n&&r.setHours(0,-r.getTimezoneOffset(),0,0),r},this.generate_guid=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)})},this.is_guid=function(e){return!("string"!=typeof e||e.length<36)&&(e.length>36&&(e=e.substr(0,36)),/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e))},this.is_empty_guid=function(e){return!e||e===this.blank.guid},this.is_data_obj=function(e){return e&&e instanceof E},this.is_data_mgr=function(e){return e&&e instanceof s},this.is_equal=function(e,t){return e==t||typeof e!=typeof t&&this.fix_guid(e,!1)==this.fix_guid(t,!1)},this.blob_as_text=function(e,t){return new Promise(function(n,r){var a=new FileReader;switch(a.onload=function(e){n(a.result)},a.onerror=function(e){r(e)},t){case"array":a.readAsArrayBuffer(e);break;case"data_url":a.readAsDataURL(e);break;default:a.readAsText(e)}})}}function n(){function e(e,t,n,r,a){return new Promise(function(i,o){if("undefined"==typeof window&&r&&r.request)r.request({url:encodeURI(t),headers:{Authorization:r.auth}},function(e,t,n){e?o(e):200!=t.statusCode?o({message:t.statusMessage,description:n,status:t.statusCode}):i({response:n})});else{var s=new XMLHttpRequest;if(window.dhx4&&window.dhx4.isIE&&(t=encodeURI(t)),r){var l,u;"object"==typeof r&&r.username&&r.hasOwnProperty("password")?(l=r.username,u=r.password):K.ajax.username&&K.ajax.authorized?(l=K.ajax.username,u=K.aes.Ctr.decrypt(K.ajax.password)):(l=K.wsql.get_user_param("user_name"),u=K.aes.Ctr.decrypt(K.wsql.get_user_param("user_pwd")),!l&&K.job_prm&&K.job_prm.guest_name&&(l=K.job_prm.guest_name,u=K.aes.Ctr.decrypt(K.job_prm.guest_pwd))),s.open(e,t,!0,l,u),s.withCredentials=!0,s.setRequestHeader("Authorization","Basic "+btoa(unescape(encodeURIComponent(l+":"+u))))}else s.open(e,t,!0);a&&a.call(this,s),"GET"!=e?this.hide_headers||r.hide_headers||(s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.setRequestHeader("X-Requested-With","XMLHttpRequest")):n=null,s.onload=function(){200==s.status&&(s.response instanceof Blob||"<!DOCTYPE"!==s.response.substr(0,9))?(void 0==s.responseURL&&(s.responseURL=t),i(s)):o(s.response?{message:s.statusText,description:s.response,status:s.status}:Error(s.statusText))},s.onerror=function(){o(Error("Network Error"))},s.send(n)}})}this.username="",this.password="",this.root=!0,this.authorized=!1,this.get=function(t){return e.call(this,"GET",t)},this.post=function(t,n){return 1==arguments.length?n="":2==arguments.length&&"function"==typeof n?(onLoad=n,n=""):n=String(n),e.call(this,"POST",t,n)},this.get_ex=function(t,n,r){return e.call(this,"GET",t,null,n,r)},this.post_ex=function(t,n,r,a){return e.call(this,"POST",t,n,r,a)},this.put_ex=function(t,n,r,a){return e.call(this,"PUT",t,n,r,a)},this.patch_ex=function(t,n,r,a){return e.call(this,"PATCH",t,n,r,a)},this.delete_ex=function(t,n,r){return e.call(this,"DELETE",t,null,n,r)},this.get_and_show_blob=function(e,t,n){function r(t){return e=window.URL.createObjectURL(t.response),a=window.open(e,"wnd_print",i),a.onload=function(t){window.URL.revokeObjectURL(e)},a}var a,i="menubar=no,toolbar=no,location=no,status=no,directories=no,resizable=yes,scrollbars=yes";if(!(e instanceof Blob))return!n||"string"==typeof n&&-1!=n.toLowerCase().indexOf("post")?this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(r):this.get_ex(e,!0,function(e){e.responseType="blob"}).then(r);Promise.resolve(r({response:e}))},this.get_and_save_blob=function(e,t,n){return this.post_ex(e,"object"==typeof t?JSON.stringify(t):t,!0,function(e){e.responseType="blob"}).then(function(e){saveAs(e.response,n)})},this.default_attr=function(e,t){e.url||(e.url=t),e.username||(e.username=this.username),e.password||(e.password=this.password),e.hide_headers=!0,K.job_prm["1c"]&&(e.auth=K.job_prm["1c"].auth,e.request=K.job_prm["1c"].request)}}function r(){var e,t=this,n={};this.__define({js_time_diff:{value:-new Date("0001-01-01").valueOf()},time_diff:{get:function(){var e=this.get_user_param("time_diff","number");return!e||isNaN(e)||e<621355716e5||e>62135622e6?this.js_time_diff:e}},set_user_param:{value:function(t,r){"object"==typeof r?(n[t]=r,r=JSON.stringify(r)):!1===r||"false"===r?(n[t]=!1,r=""):n[t]=r,e.setItem(K.job_prm.local_storage_prefix+t,r)}},get_user_param:{value:function(t,r){return!n.hasOwnProperty(t)&&e&&(n[t]=this.fetch_type(e.getItem(K.job_prm.local_storage_prefix+t),r)),n[t]}},promise:{value:function(e,n){return new Promise(function(r,a){t.alasql(e,n||[],function(e,t){t?a(t):r(e)})})}},save_options:{value:function(e,n){return t.set_user_param(e+"_"+n.name,n)}},restore_options:{value:function(e,n){var r=t.get_user_param(e+"_"+n.name,"object");for(var a in r)if("object"!=typeof r[a])n[a]=r[a];else{n[a]||(n[a]={});for(var i in r[a])n[a][i]=r[a][i]}return n}},fetch_type:{value:function(e,t){if("object"==t){try{e=JSON.parse(e)}catch(t){e={}}return e}return"number"==t?K.utils.fix_number(e,!0):"date"==t?K.utils.fix_date(e,!0):"boolean"==t?K.utils.fix_boolean(e):e}},alasql:{value:"undefined"!=typeof alasql?alasql:require("alasql")},init_params:{value:function(){if(!K.job_prm.local_storage_prefix&&!K.job_prm.create_tables)return Promise.resolve();e="undefined"==typeof localStorage?{setItem:function(e,t){},getItem:function(e){}}:localStorage;var n,r=[{p:"user_name",v:"",t:"string"},{p:"user_pwd",v:"",t:"string"},{p:"browser_uid",v:K.utils.generate_guid(),t:"string"},{p:"zone",v:K.job_prm.hasOwnProperty("zone")?K.job_prm.zone:1,t:K.job_prm.zone_is_string?"string":"number"},{p:"enable_save_pwd",v:K.job_prm.enable_save_pwd,t:"boolean"},{p:"couch_direct",v:!K.job_prm.hasOwnProperty("couch_direct")||K.job_prm.couch_direct,t:"boolean"},{p:"couch_path",v:K.job_prm.couch_path,t:"string"},{p:"rest_path",v:"",t:"string"},{p:"skin",v:"dhx_web",t:"string"}];K.job_prm.additional_params&&(r=r.concat(K.job_prm.additional_params)),e.getItem(K.job_prm.local_storage_prefix+"zone")||(n=K.job_prm.hasOwnProperty("zone")?K.job_prm.zone:1),K.job_prm.url_prm.hasOwnProperty("zone")&&(n=K.job_prm.zone_is_string?K.job_prm.url_prm.zone:K.utils.fix_number(K.job_prm.url_prm.zone,!0)),void 0!==n&&t.set_user_param("zone",n),r.forEach(function(e){(void 0==("boolean"==e.t?t.get_user_param(e.p):t.get_user_param(e.p,e.t))||!t.get_user_param(e.p,e.t)&&-1!=e.p.indexOf("url"))&&t.set_user_param(e.p,K.job_prm.hasOwnProperty(e.p)?K.job_prm[e.p]:e.v)});var a={path:t.get_user_param("couch_path","string")||K.job_prm.couch_path||"",zone:t.get_user_param("zone","number"),prefix:K.job_prm.local_storage_prefix,suffix:t.get_user_param("couch_suffix","string")||"",direct:t.get_user_param("couch_direct","boolean"),user_node:K.job_prm.user_node,noreplicate:K.job_prm.noreplicate};a.path&&(t.__define("pouch",{value:new i}),t.pouch.init(a)),this.create_tables&&(this.alasq(this.create_tables,[]),this.create_tables="")}},drop_tables:{value:function(e){function n(){i--,i<=0?setTimeout(e,10):r()}function r(){var e=o[i-1].tableid;"_"==e.substr(0,1)?n():t.alasql("drop table IF EXISTS "+e,[],n)}function a(e){o=e,(i=e.length)?r():n()}var i=0,o=[];t.alasql("SHOW TABLES",[],a)}}}),this.__define({aladb:{value:new this.alasql.Database("md")}})}function a(){this.toString=function(){return"Интернационализация сообщений"},"undefined"!=typeof window&&"dhtmlx"in window&&(this.show_msg=function(e,t){if(e){if("string"==typeof e){if(K.iface.synctxt)return void K.iface.synctxt.show_message(e);e={type:"info",text:e}}else Array.isArray(e)&&e.length>1&&(e={type:"info",text:"<b>"+e[0]+"</b><br />"+e[1]});t&&"function"==typeof t.setText&&t.setText(e.text),dhtmlx.message(e)}},dhtmlx.message.position="bottom",this.check_soap_result=function(e){return e?"limit_query"==e.error?(K.iface.docs.progressOff(),K.msg.show_msg({type:"alert-warning",text:K.msg.limit_query.replace("%1",e.queries).replace("%2",e.queries_avalable),title:K.msg.srv_overload}),!0):"network"==e.error||"empty"==e.error?(K.iface.docs.progressOff(),K.msg.show_msg({type:"alert-warning",text:K.msg.error_network,title:K.msg.error_critical}),!0):e.error&&e.error_description?(K.iface.docs.progressOff(),-1!=e.error_description.indexOf("Недостаточно прав")&&(e.error_type="alert-warning",e.error_title=K.msg.error_rights),K.msg.show_msg({type:e.error_type||"alert-error",text:e.error_description,title:e.error_title||K.msg.error_critical}),!0):e.error&&!e.messages?(K.iface.docs.progressOff(),K.msg.show_msg({type:"alert-error",title:K.msg.error_critical,text:K.msg.unknown_error.replace("%1","unknown_error")}),!0):void 0:(K.msg.show_msg({type:"alert-error",text:K.msg.empty_response,title:K.msg.error_critical}),!0)},this.show_not_implemented=function(){K.msg.show_msg({type:"alert-warning",text:K.msg.not_implemented,title:K.msg.main_title})})}function i(){var e,t,n,r,a=this,i={};a.__define({DB:{value:"undefined"==typeof PouchDB?require("pouchdb-core").plugin(require("pouchdb-adapter-memory")).plugin(require("pouchdb-adapter-http")).plugin(require("pouchdb-replication")).plugin(require("pouchdb-mapreduce")).plugin(require("pouchdb-find")):PouchDB},init:{value:function(e){i._mixin(e),i.path&&0!=i.path.indexOf("http")&&"undefined"!=typeof location&&(i.path=location.protocol+"//"+location.host+i.path)}},local:{get:function(){if(!e){var t={auto_compaction:!0,revs_limit:2};e={ram:new a.DB(i.prefix+i.zone+"_ram",t),doc:i.direct?a.remote.doc:new a.DB(i.prefix+i.zone+"_doc",t),meta:new a.DB(i.prefix+"meta",t),sync:{}}}return i.path&&!e._meta&&(e._meta=new a.DB(i.path+"meta",{skip_setup:!0}),a.run_sync(e.meta,e._meta,"meta")),e}},remote:{get:function(){if(!t){var e={skip_setup:!0,adapter:"http"};t={},K.md.bases().forEach(function(n){t[n]="ram"==n?new a.DB(i.path+i.zone+"_"+n,e):new a.DB(i.path+i.zone+"_"+n+(i.suffix?"_"+i.suffix:""),e)})}return t}},log_in:{value:function(e,r){if(void 0==e&&void 0==r){if(!K.job_prm.guests||!K.job_prm.guests.length)return Promise.reject(new Error("username & password not defined"));e=K.job_prm.guests[0].username,r=K.aes.Ctr.decrypt(K.job_prm.guests[0].password)}if(n)return n.username==e?Promise.resolve():Promise.reject(new Error("need logout first"));var i=K.md.bases(),o=[];return this.remote,i.forEach(function(n){o.push(t[n].login(e,r))}),Promise.all(o).then(function(){return n={username:e},setTimeout(function(){K.wsql.get_user_param("user_name")!=e&&K.wsql.set_user_param("user_name",e),K.wsql.get_user_param("enable_save_pwd")?K.aes.Ctr.decrypt(K.wsql.get_user_param("user_pwd"))!=r&&K.wsql.set_user_param("user_pwd",K.aes.Ctr.encrypt(r)):""!=K.wsql.get_user_param("user_pwd")&&K.wsql.set_user_param("user_pwd",""),K.eve.callEvent("user_log_in",[e])}),o.length=0,i.forEach(function(e){a.local[e]&&a.remote[e]&&a.local[e]!=a.remote[e]&&o.push(a.run_sync(a.local[e],a.remote[e],e))}),Promise.all(o)}).then(function(){return a.local._loading?new Promise(function(e,t){K.eve.attachEvent("pouch_data_loaded",e)}):a.call_data_loaded()}).catch(function(e){K.eve.callEvent("user_log_fault",[e])})}},log_out:{value:function(){if(n){if(e.sync.doc)try{e.sync.doc.cancel()}catch(e){}if(e.sync.ram)try{e.sync.ram.cancel()}catch(e){}n=null}return K.eve.callEvent("log_out"),i.direct&&setTimeout(function(){K.eve.redirect=!0,location.reload(!0)},1e3),t&&t.ram?t.ram.logout().then(function(){if(t&&t.doc)return t.doc.logout()}).then(function(){t&&t.ram&&delete t.ram,t&&t.doc&&delete t.doc,t=null,K.eve.callEvent("user_log_out")}):Promise.resolve()}},reset_local_data:{value:function(){var e=a.local.ram.destroy.bind(a.local.ram),t=a.local.doc.destroy.bind(a.local.doc),n=function(){setTimeout(function(){K.eve.redirect=!0,location.reload(!0)},1e3)};a.log_out(),setTimeout(function(){e().then(t).catch(t).then(n).catch(n)},1e3)}},call_data_loaded:{value:function(t){return r=!0,t||(t=e.sync._page||{}),K.md.load_doc_ram().then(function(){setTimeout(function(){K.eve.callEvent(t.note="pouch_data_loaded",[t])},1e3)})}},load_data:{value:function(){var e={limit:800,include_docs:!0},t={total_rows:0,limit:e.limit,page:0,start:Date.now()};return new Promise(function(n,r){function i(){a.local.ram.allDocs(e,function(o,s){s?(t.page++,t.total_rows=s.total_rows,t.duration=Date.now()-t.start,K.eve.callEvent("pouch_load_data_page",[t]),a.load_changes(s,e)?i():(n(),a.call_data_loaded(t))):o&&(r(o),K.eve.callEvent("pouch_load_data_error",[o]))})}a.local.ram.info().then(function(e){e.doc_count>=(K.job_prm.pouch_ram_doc_count||10)?(K.eve.callEvent("pouch_load_data_start",[t]),a.local._loading=!0,i()):(K.eve.callEvent("pouch_load_data_error",[e]),r(e))})})}},authorized:{get:function(){return n&&n.username}},data_loaded:{get:function(){return!!r}},run_sync:{value:function(t,n,i){var o,s;return t.info().then(function(e){return o=e,n.info()}).then(function(e){return"ram"!=i?e:n.get("data_version").then(function(t){return t.version!=K.wsql.get_user_param("couch_ram_data_version")&&(K.wsql.get_user_param("couch_ram_data_version")&&(e=a.reset_local_data()),K.wsql.set_user_param("couch_ram_data_version",t.version)),e}).catch(function(e){K.record_log(e)}).then(function(){return e})}).then(function(l){if(l)return s={id:i,total_rows:l.doc_count+l.doc_del_count,local_rows:o.doc_count,docs_written:0,limit:200,page:0,start:Date.now()},"ram"==i&&o.doc_count<(K.job_prm.pouch_ram_doc_count||10)?K.eve.callEvent("pouch_load_data_start",[s]):K.eve.callEvent("pouch_"+i+"_sync_start"),new Promise(function(l,u){function _(c,f){return c.on("change",function(e){!r&&o.doc_count<(K.job_prm.pouch_ram_doc_count||10)&&(s.page++,s.docs_written=e.docs_written,s.duration=Date.now()-s.start,K.eve.callEvent("pouch_load_data_page",[s])),"ram"!=i&&(e.update_only=!0),a.load_changes(e),K.eve.callEvent("pouch_change",[i,e])}).on("paused",function(e){K.eve.callEvent("pouch_paused",[i,e])}).on("active",function(e){K.eve.callEvent("pouch_active",[i,e])}).on("denied",function(e){K.eve.callEvent("pouch_denied",[i,e])}).on("complete",function(r){f&&(f.live=!0,f.retry=!0,"ram"==i||"meta"==i||K.wsql.get_user_param("zone")==K.job_prm.zone_demo?e.sync[i]=_(t.replicate.from(n,f)):e.sync[i]=_(t.sync(n,f)),l(i))}).on("error",function(e){u([i,e]),K.eve.callEvent("pouch_error",[i,e])})}var c={batch_size:200,batches_limit:6};"meta"==i?(c.filter="auth/meta",c.live=!0,c.retry=!0):K.job_prm.pouch_filter&&K.job_prm.pouch_filter[i]&&(c.filter=K.job_prm.pouch_filter[i]),_(t.replicate.from(n,c),c)})})}},load_obj:{value:function(e){return e._manager.pouch_db.get(e.class_name+"|"+e.ref).then(function(t){delete t._id,delete t._rev,e._mixin(t)._set_loaded()}).catch(function(e){if(404!=e.status)throw e}).then(function(t){return e})}},save_obj:{value:function(e,t){var n=e._data;if(!n||n._saving&&!n._modified)return Promise.resolve(e);if(n._saving&&n._modified)return new Promise(function(n,r){setTimeout(function(){n(a.save_obj(e,t))},100)});n._saving=!0;var r=e._obj._clone(void 0,!0),i=t.db||e._manager.pouch_db;return r.class_name=e.class_name,r._id=r.class_name+"|"+e.ref,delete r.ref,t.attachments&&(r._attachments=t.attachments),(e.is_new()?Promise.resolve():i.get(r._id)).then(function(e){if(e){r._rev=e._rev;for(var t in e._attachments)r._attachments||(r._attachments={}),r._attachments[t]||(r._attachments[t]=e._attachments[t])}}).catch(function(e){if(e&&404!=e.status)throw e}).then(function(){return i.put(r)}).then(function(){if(e.is_new()&&e._set_loaded(e.ref),r._attachments){e._attachments||(e._attachments={});for(var t in r._attachments)e._attachments[t]&&r._attachments[t].stub||(e._attachments[t]=r._attachments[t])}return delete n._saving,e}).catch(function(e){if(delete n._saving,e&&404!=e.status)throw e})}},load_changes:{value:function(e,t){var n,r,a,i,o={};if(t)n=e.rows;else if(e.direction){if("pull"!=e.direction)return;n=e.change.docs}else n=e.docs;if(n.length>0){t&&(t.startkey=n[n.length-1].key,t.skip=1),n.forEach(function(e){if(!(r=t?e.doc:e))if(e.value&&e.value.deleted)r={_id:e.id,_deleted:!0};else if(e.error)return;i=r._id.split("|"),a=i[0].split("."),r.ref=i[1],delete r._id,delete r._rev,o[a[0]]||(o[a[0]]={}),o[a[0]][a[1]]||(o[a[0]][a[1]]=[]),o[a[0]][a[1]].push(r)});for(var s in o)for(a in o[s])K[s]&&K[s][a]&&K[s][a].load_array(o[s][a],!e.update_only||-1!=K[s][a].cachable.indexOf("ram")||"update_only");return!0}return!1}},backup_database:{value:function(e){}},restore_database:{value:function(e){}}})}function o(){function e(e){return e.info().then(function(){return e.get("meta")}).then(function(n){return K._patch(t,n),n=null,e.get("meta_patch")}).then(function(e){return K._patch(t,e),e=null,delete t._id,delete t._rev,t})}var t={enm:{accumulation_record_type:[{order:0,name:"debit",synonym:"Приход"},{order:1,name:"credit",synonym:"Расход"}],sort_directions:[{order:0,name:"asc",synonym:"По возрастанию"},{order:1,name:"desc",synonym:"По убыванию"}],comparison_types:[{order:0,name:"gt",synonym:"Больше"},{order:1,name:"gte",synonym:"Больше или равно"},{order:2,name:"lt",synonym:"Меньше"},{order:3,name:"lte",synonym:"Меньше или равно "},{order:4,name:"eq",synonym:"Равно"},{order:5,name:"ne",synonym:"Не равно"},{order:6,name:"in",synonym:"В списке"},{order:7,name:"nin",synonym:"Не в списке"},{order:8,name:"lke",synonym:"Подобно "},{order:9,name:"nlk",synonym:"Не подобно"}]},cat:{meta_objs:{fields:{}},meta_fields:{fields:{}},scheme_settings:{name:"scheme_settings",synonym:"Настройки отчетов и списков",input_by_string:["name"],hierarchical:!1,has_owners:!1,group_hierarchy:!0,main_presentation_name:!0,code_length:0,fields:{obj:{synonym:"Объект",tooltip:"Имя класса метаданных",type:{types:["string"],str_len:250}},user:{synonym:"Пользователь",tooltip:"Если пусто - публичная настройка",type:{types:["string"],str_len:50}},order:{synonym:"Порядок",tooltip:"Порядок варианта",type:{types:["number"],digits:6,fraction_figits:0}},query:{synonym:"Запрос",tooltip:"Индекс CouchDB или текст SQL",type:{types:["string"],str_len:0}},date_from:{synonym:"Начало периода",tooltip:"",type:{types:["date"],date_part:"date"}},date_till:{synonym:"Конец периода",tooltip:"",type:{types:["date"],date_part:"date"}},formula:{synonym:"Формула",tooltip:"Формула инициализации",type:{types:["cat.formulas"],is_ref:!0}},tag:{synonym:"Дополнительные свойства",type:{types:["string"],str_len:0}}},tabular_sections:{fields:{name:"fields",synonym:"Доступные поля",tooltip:"Состав, порядок и ширина колонок",fields:{parent:{synonym:"Родитель",tooltip:"Для плоского списка, родитель пустой",type:{types:["string"],str_len:100}},use:{synonym:"Использование",tooltip:"",type:{types:["boolean"]}},field:{synonym:"Поле",tooltip:"",type:{types:["string"],str_len:100}},width:{synonym:"Ширина",tooltip:"",type:{types:["string"],str_len:6}},caption:{synonym:"Заголовок",tooltip:"",type:{types:["string"],str_len:100}},tooltip:{synonym:"Подсказка",tooltip:"",type:{types:["string"],str_len:100}},ctrl_type:{synonym:"Тип",tooltip:"Тип элемента управления",type:{types:["string"],str_len:100}},formatter:{synonym:"Формат",tooltip:"Функция форматирования",type:{types:["cat.formulas"],is_ref:!0}},editor:{synonym:"Редактор",tooltip:"Компонент редактирования",type:{types:["cat.formulas"],is_ref:!0}}}},sorting:{name:"sorting",synonym:"Поля сортировки",tooltip:"",fields:{parent:{synonym:"Родитель",tooltip:"",type:{types:["string"],str_len:100}},use:{synonym:"Использование",tooltip:"",type:{types:["boolean"]}},field:{synonym:"Поле",tooltip:"",type:{types:["string"],str_len:100}},direction:{synonym:"Направление",tooltip:"",type:{types:["enm.sort_directions"],is_ref:!0}}}},dimensions:{name:"dimensions",synonym:"Поля группировки",tooltip:"",fields:{parent:{synonym:"Родитель",tooltip:"",type:{types:["string"],str_len:100}},use:{synonym:"Использование",tooltip:"",type:{types:["boolean"]}},field:{synonym:"Поле",tooltip:"",type:{types:["string"],str_len:100}}}},resources:{name:"resources",synonym:"Ресурсы",tooltip:"",fields:{parent:{synonym:"Родитель",tooltip:"",type:{types:["string"],str_len:100}},use:{synonym:"Использование",tooltip:"",type:{types:["boolean"]}},field:{synonym:"Поле",tooltip:"",type:{types:["string"],str_len:100}},formula:{synonym:"Формула",tooltip:"По умолчанию - сумма",type:{types:["cat.formulas"],is_ref:!0}}}},selection:{name:"selection",synonym:"Отбор",tooltip:"",fields:{parent:{synonym:"Родитель",tooltip:"",type:{types:["string"],str_len:100}},use:{synonym:"Использование",tooltip:"",type:{types:["boolean"]}},left_value:{synonym:"Левое значение",tooltip:"",type:{types:["string"],str_len:100}},comparison_type:{synonym:"Вид сравнения",tooltip:"",type:{types:["enm.comparison_types"],is_ref:!0}},right_value:{synonym:"Правое значение",tooltip:"",type:{types:["string"],str_len:100}}}},params:{name:"params",synonym:"Параметры",tooltip:"",fields:{param:{synonym:"Параметр",tooltip:"",type:{types:["string"],str_len:100}},value_type:{synonym:"Тип",tooltip:"Тип значения",type:{types:["string"],str_len:100}},value:{synonym:"Значение",tooltip:"Может иметь примитивный или ссылочный тип или массив",type:{types:["string","number"],str_len:0,digits:15,fraction_figits:3}}}},composition:{name:"composition",synonym:"Структура",tooltip:"",fields:{parent:{synonym:"Родитель",multiline_mode:!1,tooltip:"",type:{types:["string"],str_len:10}},use:{synonym:"Использование",tooltip:"",type:{types:["boolean"]}},field:{synonym:"Элемент",tooltip:"Элемент структуры отчета",type:{types:["string"],str_len:50}},kind:{synonym:"Вид раздела отчета",tooltip:"список, таблица, группировка строк, группировка колонок",type:{types:["string"],str_len:50}},definition:{synonym:"Описание",tooltip:"Описание раздела структуры",type:{types:["string"],str_len:50}}}}},cachable:"doc"}},doc:{},ireg:{log:{name:"log",note:"",synonym:"Журнал событий",dimensions:{date:{synonym:"Дата",multiline_mode:!1,tooltip:"Время события",type:{types:["number"],digits:15,fraction_figits:0}},sequence:{synonym:"Порядок",multiline_mode:!1,tooltip:"Порядок следования",type:{types:["number"],digits:6,fraction_figits:0}}},resources:{class:{synonym:"Класс",multiline_mode:!1,tooltip:"Класс события",type:{types:["string"],str_len:100}},note:{synonym:"Комментарий",multiline_mode:!0,tooltip:"Текст события",type:{types:["string"],str_len:0}},obj:{synonym:"Объект",multiline_mode:!0,tooltip:"Объект, к которому относится событие",type:{types:["string"],str_len:0}}}}},areg:{},dp:{scheme_settings:{name:"scheme_settings",synonym:"Варианты настроек",fields:{scheme:{synonym:"Текущая настройка",tooltip:"Текущий вариант настроек",mandatory:!0,type:{types:["cat.scheme_settings"],is_ref:!0}}}}},rep:{},cch:{},cacc:{}};Y=this,Y.create_managers=function(){},Y.bases=function(){var e={};for(var n in t)for(var r in t[n])if(t[n][r].cachable){var a=t[n][r].cachable.replace("_remote","").replace("_ram","");"meta"==a||"e1cib"==a||e[a]||(e[a]=a)}return Object.keys(e)},Y.load_doc_ram=function(){var e=[];return["cat","cch","ireg"].forEach(function(n){for(var r in t[n])"doc_ram"==t[n][r].cachable&&e.push(n+"."+r)}),K.wsql.pouch.local.doc.find({selector:{class_name:{$in:e}},limit:1e4}).then(K.wsql.pouch.load_changes)},Y.init=function(n){function r(){if(!n||a||i)return e(n||K.wsql.pouch.local.meta).then(function(){if(!a)return t;Y.create_managers()}).catch(K.record_log);K._patch(t,n),n=null,Y.create_managers()}var a=!n||K.wsql.pouch&&n==K.wsql.pouch.local.meta,i=n&&K.wsql.pouch&&n==K.wsql.pouch.local._meta;return K.on("pouch_change",function(e,n){"meta"==e&&(t?K.iface&&K.iface.do_reload&&n.docs&&n.docs.length<4&&setTimeout(function(){K.iface.do_reload()},1e4):r())}),r()},Y.get=function(e,n){var r=e.split(".");if(!n)return t[r[0]][r[1]];var a={multiline_mode:!1,note:"",synonym:"",tooltip:"",type:{is_ref:!1,types:["string"]}},i=-1!="doc,tsk,bp".indexOf(r[0]),o=-1!="cat,cch,cacc,tsk".indexOf(r[0]);return i&&"number_doc"==n?(a.synonym="Номер",a.tooltip="Номер документа",a.type.str_len=11):i&&"date"==n?(a.synonym="Дата",a.tooltip="Дата документа",a.type.date_part="date_time",a.type.types[0]="date"):i&&"posted"==n?(a.synonym="Проведен",a.type.types[0]="boolean"):o&&"id"==n?a.synonym="Код":o&&"name"==n?a.synonym="Наименование":"_deleted"==n?(a.synonym="Пометка удаления",a.type.types[0]="boolean"):"is_folder"==n?(a.synonym="Это группа",a.type.types[0]="boolean"):"ref"==n?(a.synonym="Ссылка",a.type.is_ref=!0,a.type.types[0]=e):a=n?t[r[0]][r[1]].fields[n]:t[r[0]][r[1]],a},Y.get_classes=function(){var e={};for(var n in t){e[n]=[];for(var r in t[n])e[n].push(r)}return e},Y.sql_type=function(e,t,n,r){return"type"==t&&"cch_properties"==e.table_name||"svg"==t&&"cat_production_params"==e.table_name?" JSON":n.is_ref||-1!=n.types.indexOf("guid")?r?n.types.every(function(e){return 0==e.indexOf("enm.")})?" character varying(100)":n.hasOwnProperty("str_len")?" character varying("+Math.max(36,n.str_len)+")":" uuid":" CHAR":n.hasOwnProperty("str_len")?r?n.str_len?" character varying("+n.str_len+")":" text":" CHAR":n.date_part?r&&"date"!=n.date_part?"date_time"==n.date_part?" timestamp with time zone":" time without time zone":" Date":n.hasOwnProperty("digits")?0==n.fraction_figits?r?n.digits<7?" integer":" bigint":" INT":r?" numeric("+n.digits+","+n.fraction_figits+")":" FLOAT":-1!=n.types.indexOf("boolean")?" BOOLEAN":-1!=n.types.indexOf("json")?" JSON":r?" character varying(255)":" CHAR"},Y.sql_composite=function(e,t,n,r){var a="";return e[t].type.types.length>1&&"type"!=t&&(n=n?n.substr(0,29)+"_T":t.substr(0,29)+"_T",a=r?', "'+n+'" character varying(255)':Y.sql_mask(n)+" CHAR"),a},Y.sql_mask=function(e,t){return", "+(t?"_t_.":"")+"`"+e+"`"},Y.mgr_by_class_name=function(e){if(e){var t=e.split(".");if(t[1]&&K[t[0]])return K[t[0]][t[1]]}},Y.value_mgr=function(e,t,n,r,a){function i(e){return e instanceof s&&1==n.types.length&&(n._mgr=e),e}var o,l,u,_,c;if(n._mgr instanceof s)return n._mgr;if(1==n.types.length){if(u=n.types[0].split("."),u.length>1&&K[u[0]])return i(K[u[0]][u[1]])}else if(a&&a.type&&(u=a.type.split("."),u.length>1&&K[u[0]]))return i(K[u[0]][u[1]]);if(o=e.property||e.param,"value"==t&&o){if(K.utils.is_data_obj(o))l=o;else{if(!K.utils.is_guid(o))return;l=K.cch.properties.get(o,!1)}if(K.utils.is_data_obj(l)){if(l.is_new())return K.cat.property_values;if(_=[],l.type.types.some(function(e){if(u=e.split("."),
u.length>1&&K[u[0]][u[1]])_.push(K[u[0]][u[1]]);else if("boolean"==e)return _.push({types:["boolean"]}),!0}),1==_.length||e[t]==K.utils.blank.guid)return i(_[0]);if(r)return _;if((o=e[t])instanceof E)return o._manager;if(K.utils.is_guid(o)&&o!=K.utils.blank.guid)for(var f in _)if(c=_[f],c.get(o,!1,!0))return c}}else{if(_=[],n.types.forEach(function(e){u=e.split("."),u.length>1&&K[u[0]][u[1]]&&_.push(K[u[0]][u[1]])}),1==_.length||e[t]==K.utils.blank.guid)return i(_[0]);if(r)return _;if((o=e[t])instanceof E)return o._manager;if(K.utils.is_guid(o)&&o!=K.utils.blank.guid)for(var f in _)if(c=_[f],c.get(o,!1,!0))return c}},Y.control_by_type=function(e,t){return"boolean"==typeof t&&-1!=e.types.indexOf("boolean")?"ch":"number"==typeof t&&e.digits?e.fraction_figits<5?"calck":"edn":t instanceof Date&&e.date_part?"dhxCalendar":e.is_ref?"ocombo":e.date_part?"dhxCalendar":e.digits?e.fraction_figits<5?"calck":"edn":"boolean"==e.types[0]?"ch":e.hasOwnProperty("str_len")&&(e.str_len>=100||0==e.str_len)?"txt":"ed"},Y.ts_captions=function(e,t,n){n||(n={});var r,a=Y.get(e).tabular_sections[t],i=Y.get(e).form,o=a.fields;if(i&&i.obj){if(!i.obj.tabular_sections[t])return;n._mixin(i.obj.tabular_sections[t])}else{"contact_information"===t&&(o={type:"",kind:"",presentation:""}),n.fields=["row"],n.headers="№",n.widths="40",n.min_widths="",n.aligns="",n.sortings="na",n.types="cntr";for(var s in o)r=a.fields[s],r.hide||(n.fields.push(s),n.headers+=","+(r.synonym?r.synonym.replace(/,/g," "):s),n.types+=","+Y.control_by_type(r.type),n.sortings+=",na")}return!0},Y.syns_js=function(e){var n={DeletionMark:"_deleted",Description:"name",DataVersion:"data_version",IsFolder:"is_folder",Number:"number_doc",Date:"date","Дата":"date",Posted:"posted",Code:"id",Parent_Key:"parent",Owner_Key:"owner",Owner:"owner",Ref_Key:"ref","Ссылка":"ref",LineNumber:"row"};return n[e]?n[e]:t.syns_js[t.syns_1с.indexOf(e)]||e},Y.syns_1с=function(e){var n={_deleted:"DeletionMark",name:"Description",is_folder:"IsFolder",number_doc:"Number",date:"Date",posted:"Posted",id:"Code",ref:"Ref_Key",parent:"Parent_Key",owner:"Owner_Key",row:"LineNumber"};return n[e]?n[e]:t.syns_1с[t.syns_js.indexOf(e)]||e},Y.printing_plates=function(e){if(e)for(var n in e.doc)t.doc[n].printing_plates=e.doc[n]},Y.class_name_from_1c=function(e){var t=e.split(".");return 1==t.length?"enm."+e:("Перечисление"==t[0]?e="enm.":"Справочник"==t[0]?e="cat.":"Документ"==t[0]?e="doc.":"РегистрСведений"==t[0]?e="ireg.":"РегистрНакопления"==t[0]?e="areg.":"РегистрБухгалтерии"==t[0]?e="accreg.":"ПланВидовХарактеристик"==t[0]?e="cch.":"ПланСчетов"==t[0]?e="cacc.":"Обработка"==t[0]?e="dp.":"Отчет"==t[0]&&(e="rep."),e+Y.syns_js(t[1]))},Y.class_name_to_1c=function(e){var t=e.split(".");return 1==t.length?"Перечисление."+e:("enm"==t[0]?e="Перечисление.":"cat"==t[0]?e="Справочник.":"doc"==t[0]?e="Документ.":"ireg"==t[0]?e="РегистрСведений.":"areg"==t[0]?e="РегистрНакопления.":"accreg"==t[0]?e="РегистрБухгалтерии.":"cch"==t[0]?e="ПланВидовХарактеристик.":"cacc"==t[0]?e="ПланСчетов.":"dp"==t[0]?e="Обработка.":"rep"==t[0]&&(e="Отчет."),e+Y.syns_1с(t[1]))},Y.create_tables=function(e,t){function n(){i--,0==i?e?e(l):alasql.utils.saveFile("create_tables.sql",l):r()}function r(){var e=o[i-1];l+=e.class[e.name].get_sql_struct(t)+"; ",n()}var a,i=0,o=[],s=Y.get_classes(),l=t&&t.postgres?"":"USE md; ";"enm,cch,cacc,cat,bp,tsk,doc,ireg,areg".split(",").forEach(function(e){for(a in s[e])o.push({class:K[e],name:s[e][a]})}),i=o.length,r()}}function s(e){var t=Y.get(e),n={after_create:[],after_load:[],before_save:[],after_save:[],value_change:[],add_row:[],del_row:[]};this.__define({cachable:{get:function(){return-1!=e.indexOf("enm.")?"ram":t.cachable?t.cachable:-1!=e.indexOf("doc.")||-1!=e.indexOf("dp.")||-1!=e.indexOf("rep.")?"doc":"ram"}},class_name:{value:e,writable:!1},alatable:{get:function(){return K.wsql.aladb.tables[this.table_name]?K.wsql.aladb.tables[this.table_name].data:[]}},metadata:{value:function(e){return e?t.fields[e]||t.tabular_sections[e]:t}},on:{value:function(e,t){if("object"==typeof e)for(var r in e)e.hasOwnProperty(r)&&n[r].push(e[r]);else n[e].push(t)}},off:{value:function(e,t){if("object"==typeof e);else{var r=n[e].indexOf(t);-1!=r&&n[e].splice(r,1)}}},handle_event:{value:function(e,t,r){var a,i=[];return n[t].forEach(function(t){!1!==i&&(a=t.call(e,r),!1===a?i=a:a&&i.push(a))}),!1===i?i:i.length?1==i.length?i[0]:i.some(function(e){return"object"==typeof e&&e.then})?Promise.all(i):i:void 0}},by_ref:{value:{}}})}function l(e){l.superclass.constructor.call(this,e)}function u(e){u.superclass.constructor.call(this,e)}function _(e){_.superclass.constructor.call(this,e);var t=K.md.get(e);for(var n in t)new N(t[n],this)}function c(e){c.superclass.constructor.call(this,e),this.push=function(e,t){t&&t!=e.ref?(delete this.by_ref[e.ref],this.by_ref[t]=e):this.by_ref[e.ref]=e},this.get=function(e,t,n){if(e?"string"==typeof e&&(e={ref:e}):e={},e.ref&&n)return t?Promise.resolve(this.by_ref[e.ref]):this.by_ref[e.ref];e.action="select";var r,a=K.wsql.alasql(this.get_sql_struct(e),e._values);if(delete e.action,delete e._values,a.length)if(n)r=this.by_ref[this.get_ref(a[0])];else{r=[];for(var i in a)r.push(this.by_ref[this.get_ref(a[i])])}return t?Promise.resolve(r):r},this.unload_obj=function(e){delete this.by_ref[e],this.alatable.some(function(t,n,r){if(t.ref==e)return r.splice(n,1),!0})},this.load_array=function(e,t){for(var n,r,a=[],i=0;i<e.length;i++){if(n=this.get_ref(e[i]),(r=this.by_ref[n])||e[i]._deleted){if(e[i]._deleted){r&&r.unload();continue}(r.is_new()||t)&&(r._mixin(e[i]),r._set_loaded())}else r=new(K[this.obj_constructor()])(e[i],this),t&&r._set_loaded();a.push(r)}return a}}function f(e){f.superclass.constructor.call(this,e)}function d(e){d.superclass.constructor.call(this,e)}function p(e){p.superclass.constructor.call(this,e),this.metadata().hierarchical&&this.metadata().group_hierarchy&&K[this.obj_constructor()].prototype.__define("is_folder",{get:function(){return this._obj.is_folder||!1},set:function(e){this._obj.is_folder=K.utils.fix_boolean(e)},enumerable:!0,configurable:!0})}function h(e){h.superclass.constructor.call(this,e)}function m(e){m.superclass.constructor.call(this,e)}function y(e){y.superclass.constructor.call(this,e)}function g(e){g.superclass.constructor.call(this,e)}function b(e){b.superclass.constructor.call(this,e)}function v(){v.superclass.constructor.call(this,"ireg.log");var e;this.__define({record:{value:function(t){if(t instanceof Error)console&&console.log(t),t={class:"error",note:t.toString()};else if(t instanceof E){console&&console.log(t);var n=t._data._err;t={class:"error",obj:{type:t.class_name,ref:t.ref,presentation:t.presentation},note:n?n.text:""}}else"object"!=typeof t||t.class||t.obj?"object"!=typeof t&&(t={note:t}):t={class:"obj",obj:t,note:t.note};t.date=Date.now()+K.wsql.time_diff,e||(e=alasql.compile("select MAX(`sequence`) as `sequence` from `ireg_log` where `date` = ?"));var r=e([t.date]);t.sequence=r.length&&void 0!==r[0].sequence?parseInt(r[0].sequence)+1:0,t.class||(t.class="note"),K.wsql.alasql("insert into `ireg_log` (`ref`, `date`, `sequence`, `class`, `note`, `obj`) values (?,?,?,?,?,?)",[t.date+"¶"+t.sequence,t.date,t.sequence,t.class,t.note,t.obj?JSON.stringify(t.obj):""]),t.note&&K.msg&&K.msg.show_msg&&K.msg.show_msg([t.class,t.note])}},backup:{value:function(e,t){}},restore:{value:function(e,t){}},clear:{value:function(e,t){}},show:{value:function(e){}},get:{value:function(e,t,n){if("object"==typeof e&&(e=e.ref||""),!this.by_ref[e]){if(!1===t)return;var r=e.split("¶");K.wsql.alasql("select * from `ireg_log` where date="+r[0]+" and sequence="+r[1]).forEach(function(e){new C(e,this)}.bind(this))}return t?Promise.resolve(this.by_ref[e]):this.by_ref[e]}},get_sql_struct:{value:function(e){if(e&&"get_selection"==e.action){var t="select * from `ireg_log`";return e.date_from?e.date_till?t+=" where `date` >= ? and `date` <= ?":t+=" where `date` >= ?":e.date_till&&(t+=" where `date` <= ?"),t}return v.superclass.get_sql_struct.call(this,e)}},caption_flds:{value:function(e){var t=[],n="";if(t.push(new Col_struct("date","200","ro","left","server","Дата")),t.push(new Col_struct("class","100","ro","left","server","Класс")),t.push(new Col_struct("note","*","ro","left","server","Событие")),e.get_header){n="<head>";for(var r in t)n+='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>'.replace("%1",t[r].id).replace("%2",t[r].width).replace("%3",t[r].type).replace("%4",t[r].align).replace("%5",t[r].sort).replace("%6",t[r].caption);n+="</head>"}return{head:n,acols:t}}},data_to_grid:{value:function(e,t){var n="<?xml version='1.0' encoding='UTF-8'?><rows total_count='%1' pos='%2' set_parent='%3'>".replace("%1",e.length).replace("%2",t.start).replace("%3",t.set_parent||""),r=this.caption_flds(t);return n+=r.head,e.forEach(function(e){n+='<row id="'+e.ref+'"><cell>'+K.moment(e.date-K.wsql.time_diff).format("DD.MM.YYYY HH:mm:ss")+"."+e.sequence+"</cell><cell>"+(e.class||"")+"</cell><cell>"+(e.note||"")+"</cell></row>"}),n+"</rows>"}}})}function w(){w.superclass.constructor.call(this,"cat.meta_objs")}function x(){x.superclass.constructor.call(this,"cat.meta_fields")}function j(){j.superclass.constructor.call(this,"cat.scheme_settings")}function O(e,t){t._obj[e]||(t._obj[e]=[]),this.__define("_name",{value:e,enumerable:!1}),this.__define("_owner",{value:t,enumerable:!1}),this.__define("_obj",{value:t._obj[e],writable:!1,enumerable:!1})}function k(e){var t={};this.__define("_owner",{value:e,enumerable:!1}),this.__define("_obj",{value:t,writable:!1,enumerable:!1})}function E(e,t){var n,r={};if(t instanceof u||t instanceof _||(n=t.get(e,!1,!0)),n)return e=null,n;this.__define({_ts_:{value:function(e){return r[e]||(r[e]=new O(e,this)),r[e]},configurable:!0},_manager:{value:t},_data:{value:{_is_new:!(this instanceof N)}},_obj:{value:{ref:t instanceof _?e.name:t instanceof c?t.get_ref(e):K.utils.fix_guid(e)}}}),t.alatable&&t.push&&(t.alatable.push(this._obj),t.push(this,this._obj.ref)),e=null}function q(e,t){q.superclass.constructor.call(this,e,t),this._data&&e&&"object"==typeof e&&(this._data._silent=!0,e._not_set_loaded?(delete e._not_set_loaded,this._mixin(e)):(this._mixin(e),K.utils.is_empty_guid(this.ref)||!e.id&&!e.name||this._set_loaded(this.ref)),this._data._silent=!1)}function A(e,t){var n="";A.superclass.constructor.call(this,e,t),this.__define("presentation",{get:function(){return this.number_doc?(this._metadata.obj_presentation||this._metadata.synonym)+" №"+this.number_doc+" от "+K.moment(this.date).format(K.moment._masks.ldt):n||""},set:function(e){e&&(n=String(e))}}),e&&"object"==typeof e&&(this._data._silent=!0,this._mixin(e),this._data._silent=!1),!K.utils.is_empty_guid(this.ref)&&e.number_doc&&this._set_loaded(this.ref),e=null}function D(e){e.__define({number_doc:{get:function(){return this._obj.number_doc||""},set:function(e){this.__notify("number_doc"),this._obj.number_doc=e},enumerable:!0},date:{get:function(){return this._obj.date||K.utils.blank.date},set:function(e){this.__notify("date"),this._obj.date=K.utils.fix_date(e,!0)},enumerable:!0}})}function P(e,t){P.superclass.constructor.call(this,e,t);var n,r=t.metadata();for(n in r.fields)e[n]||(e[n]=K.utils.fetch_type("",r.fields[n].type));for(n in r.tabular_sections)e[n]||(e[n]=[]);this._mixin(e)}function R(e,t){R.superclass.constructor.call(this,e,t)}function S(e,t){S.superclass.constructor.call(this,e,t)}function N(e,t){N.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e)}function C(e,t){C.superclass.constructor.call(this,e,t),e&&"object"==typeof e&&this._mixin(e);for(var n in t.metadata().dimensions)if(!e.hasOwnProperty(n)&&e.ref){var r=e.ref.split("¶");Object.keys(t.metadata().dimensions).forEach(function(e,t){this[e]=r[t]}.bind(this));break}}function T(){this.filter_date=function(e,t,n){t||(t=new Date("2015-01-01"));var r=e+" gt datetime'"+K.moment(t).format(K.moment._masks.iso)+"'";return n&&(r+=" and "+e+" lt datetime'"+K.moment(n).format(K.moment._masks.iso)+"'"),r},this.to_data=function(e,t){var n,r,a,i,o,s,u={},_=t.metadata(),c=_.fields,f=_.tabular_sections;t instanceof l?(e.hasOwnProperty("DeletionMark")&&(u._deleted=e.DeletionMark),e.hasOwnProperty("DataVersion"),e.hasOwnProperty("Ref_Key")&&(u.ref=e.Ref_Key)):c={}._mixin(_.dimensions)._mixin(_.resources)._mixin(_.attributes),t instanceof y?(e.hasOwnProperty("Number")?u.number_doc=e.Number||e.number_doc:e.hasOwnProperty("number_doc")&&(u.number_doc=e.number_doc),e.hasOwnProperty("Date")?u.date=e.Date:e.hasOwnProperty("date")&&(u.date=e.date),e.hasOwnProperty("Posted")?u.posted=e.Posted:e.hasOwnProperty("posted")&&(u.posted=e.posted)):(_.main_presentation_name&&(e.hasOwnProperty("Description")?u.name=e.Description:e.hasOwnProperty("name")&&(u.name=e.name)),_.code_length&&(e.hasOwnProperty("Code")?u.id=e.Code:e.hasOwnProperty("id")&&(u.id=e.id)));for(r in c)if(e.hasOwnProperty(r))u[r]=e[r];else{if(o=Y.syns_1с(r),-1==o.indexOf("_Key")&&c[r].type.is_ref&&e[o+"_Key"]&&(o+="_Key"),!e.hasOwnProperty(o))continue;u[r]=e[o]}for(n in f)s="extra_fields"==n||e.hasOwnProperty(n)?n:Y.syns_1с(n),e.hasOwnProperty(s)&&(u[n]=[],e[s]&&(e[s].sort(function(e,t){return(e.LineNumber||e.row)>(t.LineNumber||t.row)}),e[s].forEach(function(e){i={};for(a in f[n].fields)o=e.hasOwnProperty(a)||"extra_fields"==n&&("property"==a||"value"==a)?a:Y.syns_1с(a),-1==o.indexOf("_Key")&&f[n].fields[a].type.is_ref&&e[o+"_Key"]&&(o+="_Key"),i[a]=e[o];u[n].push(i)})));return u},this.ajax_to_data=function(e,t){return K.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){var n=[];return e.value.forEach(function(e){n.push(H.to_data(e,t))}),n})},this.build_select=function(e,t){function n(e,r){"function"==typeof r?i+=r(t,e):(o=Y.syns_1с(e),(s=Y.get(t.class_name,e))&&(s=s.type,s.is_ref&&-1==o.indexOf("_Key")&&s.types.length&&-1==s.types[0].indexOf("enm.")&&(o+="_Key"),s.types.length&&(-1!=["boolean","number"].indexOf(typeof r)?i+=o+" eq "+r:s.is_ref&&"object"!=typeof r||r instanceof E?i+=o+" eq guid'"+r+"'":"string"==typeof r?i+=o+" eq '"+r+"'":"object"==typeof r&&(r.hasOwnProperty("like")?i+=o+" like '%"+r.like+"%'":r.hasOwnProperty("not")?i+=" not ("+n(e,r.not)+") ":r.hasOwnProperty("in")&&(i+=o+" in ("+(s.is_ref?r.in.map(function(e){return"guid'"+e+"'"}).join(","):r.in.join(","))+") ")))))}function r(e){for(var t in e)if(i?i+=" and ":i="&$filter=","or"==t&&Array.isArray(e[t])){var r=!0;e[t].forEach(function(e){r?(i+=" ( ",r=!1):i+=" or ";var t=Object.keys(e)[0];n(t,e[t])}),i+=" ) "}else n(t,e[t])}var a,i,o,s,l="";e||(e={}),e.fields&&(e.fields.forEach(function(e){"ref"==e?o="Ref_Key":(o=Y.syns_1с(e),s=Y.get(t.class_name,e).type,s.is_ref&&-1==o.indexOf("_Key")&&s.types.length&&-1==s.types[0].indexOf("enm.")&&(o+="_Key")),a?a+=",":a="&$select=",a+=o}),l+=a),e.selection&&("function"==typeof e.selection||(Array.isArray(e.selection)?e.selection.forEach(r):r(e.selection)),i&&(l+=i)),K.job_prm.rest&&-1==t.rest_name.indexOf("Module_")&&-1==t.rest_name.indexOf("DataProcessor_")&&-1==t.rest_name.indexOf("Report_")&&-1==l.indexOf(" like ")&&-1==l.indexOf(" in ")&&!t.metadata().irest?K.ajax.default_attr(e,K.job_prm.rest_url()):K.ajax.default_attr(e,K.job_prm.irest_url()),e.url+=t.rest_name+"?allowedOnly=true&$format=json&$top="+(e.top||300)+l},this.load_array=function(e,t){return H.build_select(e,t),H.ajax_to_data(e,t)},this.load_obj=function(e){var t={};return K.ajax.default_attr(t,!e._metadata.irest&&K.job_prm.rest?K.job_prm.rest_url():K.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"')?$format=json",K.ajax.get_ex(t.url,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(H.to_data(t,e._manager))._set_loaded(),e}).catch(function(t){if(404==t.status)return e;K.record_log(t)})},this.save_irest=function(e,t){var n=JSON.stringify(e),r=(void 0!=t.post?",post="+t.post:"")+(void 0!=t.operational?",operational="+t.operational:"");return K.ajax.default_attr(t,K.job_prm.irest_url()),t.url+=e._manager.rest_name+"(guid'"+e.ref+"'"+r+")",K.ajax.post_ex(t.url,n,t).then(function(e){return JSON.parse(e.response)}).then(function(t){return e._mixin(t)})},this.save_rest=function(e,t){var n,r=e.to_atom();return K.ajax.default_attr(t,K.job_prm.rest_url()),n=t.url+e._manager.rest_name,t.url=n+"(guid'"+e.ref+"')?$format=json&$select=Ref_Key,DeletionMark",K.ajax.get_ex(t.url,t).catch(function(e){return 404==e.status?{response:JSON.stringify({is_new:!0})}:Promise.reject(e)}).then(function(e){return JSON.parse(e.response)}).then(function(a){return a.is_new?K.ajax.post_ex(n,r,t):K.ajax.patch_ex(n+"(guid'"+e.ref+"')",r,t)}).then(function(t){var n=xmlToJSON.parseString(t.response,{mergeCDATA:!1,grokAttr:!0,grokText:!1,normalize:!0,xmlns:!1,namespaceKey:"_ns",textKey:"_text",valueKey:"_value",attrKey:"_attr",cdataKey:"_cdata",attrsAsObject:!1,stripAttrPrefix:!0,stripElemPrefix:!0,childrenAsArray:!1});if(n.entry&&n.entry.content&&n.entry.updated){var r,a=n.entry.content.properties,i={};for(var o in a)if(0!=o.indexOf("_"))if(r=a[o].element)if(i[o]=[],Array.isArray(r))for(var s in r){i[o][s]={};for(var l in r[s])0!=l.indexOf("_")&&(i[o][s][l]="false"!==r[s][l]._text&&r[s][l]._text)}else{i[o][0]={};for(var l in r)0!=l.indexOf("_")&&(i[o][0][l]="false"!==r[l]._text&&r[l]._text)}else i[o]="false"!==a[o]._text&&a[o]._text;return H.to_data(i,e._manager)}}).then(function(t){return e._mixin(t)})}}function M(){if(this.__define({init:{value:function(){K.__define("job_prm",{value:new L,writable:!1}),K.wsql.init_params()}},do_eventable:{value:function(e){function t(e,t){e=String(e).toLowerCase(),this._evnts.data[e]||(this._evnts.data[e]={});var n=K.utils.generate_guid();return this._evnts.data[e][n]=t,n}function n(e){if(!e)return r.call(this);for(var t in this._evnts.data){var n=0;for(var a in this._evnts.data[t])a==e?(this._evnts.data[t][a]=null,delete this._evnts.data[t][a]):n++;0==n&&(this._evnts.data[t]=null,delete this._evnts.data[t])}}function r(){for(var e in this._evnts.data){for(var t in this._evnts.data[e])this._evnts.data[e][t]=null,delete this._evnts.data[e][t];this._evnts.data[e]=null,delete this._evnts.data[e]}}function a(e,t){if(e=String(e).toLowerCase(),null==this._evnts.data[e])return!0;var n=!0;for(var r in this._evnts.data[e])n=this._evnts.data[e][r].apply(this,t)&&n;return n}function i(){for(var e in this._evnts.evnts){var t=this._evnts.evnts[e].length;if(t){for(var n=0;n<t;n++)this.emit(e,this._evnts.evnts[e][n]);this._evnts.evnts[e].length=0}}this._evnts.timer=0}e.__define({_evnts:{value:{data:{},timer:0,evnts:{}}},on:{value:t},attachEvent:{value:t},off:{value:n},detachEvent:{value:n},detachAllEvents:{value:r},checkEvent:{value:function(e){return e=String(e).toLowerCase(),null!=this._evnts.data[e]}},callEvent:{value:a},emit:{value:a},emit_async:{value:function(e,t){this._evnts.evnts[e]||(this._evnts.evnts[e]=[]),this._evnts.evnts[e].push(t),this._evnts.timer&&clearTimeout(this._evnts.timer),this._evnts.timer=setTimeout(i.bind(this),4)}}})}}}),"undefined"!=typeof window&&window.dhx4){for(var e in dhx4)this[e]=dhx4[e],delete dhx4[e];window.dhx4=this}else"undefined"==typeof WorkerGlobalScope&&this.do_eventable(this)}function L(){this.__define({offline:{value:!1,writable:!0},local_storage_prefix:{value:"",writable:!0},create_tables:{value:!0,writable:!0},url_prm:{value:"undefined"!=typeof window?this.parse_url():{}}}),K.eve.callEvent("settings",[this]);for(var e in this)"url_prm"!==e&&"function"!=typeof this[e]&&this.url_prm.hasOwnProperty[e]&&(this[e]=this.url_prm[e])}/**
* AES implementation in JavaScript                                   (c) Chris Veness 2005-2016
*                                                                                   MIT Licence
* www.movable-type.co.uk/scripts/aes.html
*/
function I(e){"use strict";function t(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)})}function n(e){try{return decodeURIComponent(escape(e))}catch(t){return e}}function r(e){if("undefined"!=typeof btoa)return btoa(e);if("undefined"!=typeof Buffer)return new Buffer(e,"binary").toString("base64");throw new Error("No Base64 Encode")}function a(e){if("undefined"!=typeof atob)return atob(e);if("undefined"!=typeof Buffer)return new Buffer(e,"base64").toString("binary");throw new Error("No Base64 Decode")}var i=this;i.cipher=function(e,t){for(var n=t.length/4-1,r=[[],[],[],[]],a=0;a<16;a++)r[a%4][Math.floor(a/4)]=e[a];r=i.addRoundKey(r,t,0,4);for(var o=1;o<n;o++)r=i.subBytes(r,4),r=i.shiftRows(r,4),r=i.mixColumns(r,4),r=i.addRoundKey(r,t,o,4);r=i.subBytes(r,4),r=i.shiftRows(r,4),r=i.addRoundKey(r,t,n,4);for(var s=new Array(16),a=0;a<16;a++)s[a]=r[a%4][Math.floor(a/4)];return s},i.keyExpansion=function(e){for(var t=e.length/4,n=t+6,r=new Array(4*(n+1)),a=new Array(4),o=0;o<t;o++){var s=[e[4*o],e[4*o+1],e[4*o+2],e[4*o+3]];r[o]=s}for(var o=t;o<4*(n+1);o++){r[o]=new Array(4);for(var l=0;l<4;l++)a[l]=r[o-1][l];if(o%t==0){a=i.subWord(i.rotWord(a));for(var l=0;l<4;l++)a[l]^=i.rCon[o/t][l]}else t>6&&o%t==4&&(a=i.subWord(a));for(var l=0;l<4;l++)r[o][l]=r[o-t][l]^a[l]}return r},i.subBytes=function(e,t){for(var n=0;n<4;n++)for(var r=0;r<t;r++)e[n][r]=i.sBox[e[n][r]];return e},i.shiftRows=function(e,t){for(var n=new Array(4),r=1;r<4;r++){for(var a=0;a<4;a++)n[a]=e[r][(a+r)%t];for(var a=0;a<4;a++)e[r][a]=n[a]}return e},i.mixColumns=function(e,t){for(var n=0;n<4;n++){for(var r=new Array(4),a=new Array(4),i=0;i<4;i++)r[i]=e[i][n],a[i]=128&e[i][n]?e[i][n]<<1^283:e[i][n]<<1;e[0][n]=a[0]^r[1]^a[1]^r[2]^r[3],e[1][n]=r[0]^a[1]^r[2]^a[2]^r[3],e[2][n]=r[0]^r[1]^a[2]^r[3]^a[3],e[3][n]=r[0]^a[0]^r[1]^r[2]^a[3]}return e},i.addRoundKey=function(e,t,n,r){for(var a=0;a<4;a++)for(var i=0;i<r;i++)e[a][i]^=t[4*n+i][a];return e},i.subWord=function(e){for(var t=0;t<4;t++)e[t]=i.sBox[e[t]];return e},i.rotWord=function(e){for(var t=e[0],n=0;n<3;n++)e[n]=e[n+1];return e[3]=t,e},i.sBox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],i.rCon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]],i.Ctr={},i.Ctr.encrypt=function(n,a,o){128!=o&&192!=o&&256!=o&&(o=128),n=t(n),a=t(a||e);for(var s=o/8,l=new Array(s),u=0;u<s;u++)l[u]=u<a.length?a.charCodeAt(u):0;var _=i.cipher(l,i.keyExpansion(l));_=_.concat(_.slice(0,s-16));for(var c=new Array(16),f=(new Date).getTime(),d=f%1e3,p=Math.floor(f/1e3),h=Math.floor(65535*Math.random()),u=0;u<2;u++)c[u]=d>>>8*u&255;for(var u=0;u<2;u++)c[u+2]=h>>>8*u&255;for(var u=0;u<4;u++)c[u+4]=p>>>8*u&255;for(var m="",u=0;u<8;u++)m+=String.fromCharCode(c[u]);for(var y=i.keyExpansion(_),g=Math.ceil(n.length/16),b="",v=0;v<g;v++){for(var w=0;w<4;w++)c[15-w]=v>>>8*w&255;for(var w=0;w<4;w++)c[15-w-4]=v/4294967296>>>8*w;for(var x=i.cipher(c,y),j=v<g-1?16:(n.length-1)%16+1,O=new Array(j),u=0;u<j;u++)O[u]=x[u]^n.charCodeAt(16*v+u),O[u]=String.fromCharCode(O[u]);b+=O.join(""),"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&v%1e3==0&&self.postMessage({progress:v/g})}return b=r(m+b)},i.Ctr.decrypt=function(r,o,s){128!=s&&192!=s&&256!=s&&(s=128),r=a(r),o=t(o||e);for(var l=s/8,u=new Array(l),_=0;_<l;_++)u[_]=_<o.length?o.charCodeAt(_):0;var c=i.cipher(u,i.keyExpansion(u));c=c.concat(c.slice(0,l-16));for(var f=new Array(8),d=r.slice(0,8),_=0;_<8;_++)f[_]=d.charCodeAt(_);for(var p=i.keyExpansion(c),h=Math.ceil((r.length-8)/16),m=new Array(h),y=0;y<h;y++)m[y]=r.slice(8+16*y,8+16*y+16);r=m;for(var g="",y=0;y<h;y++){for(var b=0;b<4;b++)f[15-b]=y>>>8*b&255;for(var b=0;b<4;b++)f[15-b-4]=(y+1)/4294967296-1>>>8*b&255;for(var v=i.cipher(f,p),w=new Array(r[y].length),_=0;_<r[y].length;_++)w[_]=v[_]^r[y].charCodeAt(_),w[_]=String.fromCharCode(w[_]);g+=w.join(""),"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&y%1e3==0&&self.postMessage({progress:y/h})}return g=n(g)}}Object.defineProperties(Object.prototype,{__define:{value:function(e,t){return t?Object.defineProperty(this,e,t):Object.defineProperties(this,e),this}},_extend:{value:function(e){var t=function(){};t.prototype=e.prototype,this.prototype=new t,this.prototype.constructor=this,this.__define("superclass",{value:e.prototype,enumerable:!1})}},_mixin:{value:function(e,t,n){var r,a,i={};if(t&&t.length)for(r=0;r<t.length;r++)a=t[r],n&&-1!=n.indexOf(a)||void 0!==i[a]&&i[a]==e[a]||(this[a]=e[a]);else for(a in e)n&&-1!=n.indexOf(a)||void 0!==i[a]&&i[a]==e[a]||(this[a]=e[a]);return this}},_clone:{value:function(e,t){if(!this||"object"!=typeof this)return this;var n,r,a="function"==typeof this.pop?[]:{};for(n in this)e&&-1!=e.indexOf(n)||this.hasOwnProperty(n)&&(r=this[n],r?"function"==typeof r||r instanceof E||r instanceof s?a[n]=r:"object"==typeof r?r instanceof Date?a[n]=t?r.toJSON():r:a[n]=r._clone(e,t):a[n]=r:a[n]=r);return a}}}),Date.prototype.toJSON=function(){return K.moment(this).format(K.moment._masks.iso)},Number.prototype.round||(Number.prototype.round=function(e){var t=Math.pow(10,e);return Math.round(this*t)/t}),Number.prototype.pad||(Number.prototype.pad=function(e){for(var t=String(this);t.length<(e||2);)t="0"+t;return t}),Object.observe||Object.unobserve||Object.getNotifier||Object.prototype.__define({observe:{value:function(e,t){e&&(e._observers||e.__define({_observers:{value:[],enumerable:!1},_notis:{value:[],enumerable:!1}}),e._observers.push(t))},enumerable:!1},unobserve:{value:function(e,t){if(e&&e._observers){t||(e._observers.length=0);for(var n=0;n<e._observers.length;n++)if(e._observers[n]===t){e._observers.splice(n,1);break}}},enumerable:!1},getNotifier:{value:function(e){var t;return{notify:function(n){e._observers&&n&&(n.object||(n.object=e),e._notis.push(n),n=null,t&&clearTimeout(t),t=setTimeout(function(){e._notis.length&&(e._observers.forEach(function(t){t(e._notis)}),e._notis.length=0),t=!1},4))}}},enumerable:!1}});var K=new e;"undefined"!=typeof window&&window.dhx4&&(dhx4.dateFormat.ru="%d.%m.%Y",dhx4.dateLang="ru",dhx4.dateStrings={ru:{monthFullName:["Январь","Февраль","Март","Апрель","Maй","Июнь","Июль","Август","Сентябрь","Oктябрь","Ноябрь","Декабрь"],monthShortName:["Янв","Фев","Maр","Aпр","Maй","Июн","Июл","Aвг","Сен","Окт","Ноя","Дек"],dayFullName:["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],dayShortName:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"]}}),function(e){e.store_url_od="https://chrome.google.com/webstore/detail/hcncallbdlondnoadgjomnhifopfaage",e.argument_is_not_ref="Аргумент не является ссылкой",e.addr_title="Ввод адреса",e.cache_update_title="Обновление кеша браузера",e.cache_update="Выполняется загрузка измененных файлов<br/>и их кеширование в хранилище браузера",e.cancel="Отмена",e.delivery_area_empty="Укажите район доставки",e.empty_login_password="Не указаны имя пользователя или пароль",e.empty_response="Пустой ответ сервера",e.empty_geocoding="Пустой ответ геокодера. Вероятно, отслеживание адреса запрещено в настройках браузера",e.error_geocoding="Ошибка геокодера",e.error_auth="Авторизация пользователя не выполнена",e.error_critical="Критическая ошибка",e.error_metadata="Ошибка загрузки метаданных конфигурации",e.error_network="Ошибка сети или сервера - запрос отклонен",e.error_rights="Ограничение доступа",e.error_low_acl="Недостаточно прав для выполнения операции",e.file_size="Запрещена загрузка файлов<br/>размером более ",e.file_confirm_delete="Подтвердите удаление файла ",e.file_new_date="Файлы на сервере обновлены<br /> Рекомендуется закрыть браузер и войти<br />повторно для применения обновления",e.file_new_date_title="Версия файлов",e.init_catalogues="Загрузка справочников с сервера",e.init_catalogues_meta=": Метаданные объектов",e.init_catalogues_tables=": Реструктуризация таблиц",e.init_catalogues_nom=": Базовые типы + номенклатура",e.init_catalogues_sys=": Технологические справочники",e.init_login="Укажите имя пользователя и пароль",e.requery="Повторите попытку через 1-2 минуты",e.limit_query="Превышено число обращений к серверу<br/>Запросов за минуту:%1<br/>Лимит запросов:%2<br/>"+e.requery,e.long_operation="Длительная операция",e.logged_in="Авторизован под именем: ",e.log_out_title="Отключиться от сервера?",e.log_out_break="<br/>Завершить синхронизацию?",e.sync_title="Обмен с сервером",e.sync_complite="Синхронизация завершена",e.main_title="Окнософт: заказ дилера ",e.mark_delete_confirm="Пометить объект %1 на удаление?",e.mark_undelete_confirm="Снять пометку удаления с объекта %1?",e.meta={cat:"Справочник",doc:"Документ",cch:"План видов характеристик",cacc:"Планы счетов",tsk:"Задача",ireg:"Регистр сведений",areg:"Регистр накопления",bp:"Бизнес процесс",ts_row:"Строка табличной части",dp:"Обработка",rep:"Отчет"},e.meta_cat="Справочники",e.meta_doc="Документы",e.meta_cch="Планы видов характеристик",e.meta_cacc="Планы счетов",e.meta_tsk="Задачи",e.meta_ireg="Регистры сведений",e.meta_areg="Регистры накопления",e.meta_mgr="Менеджер",e.meta_cat_mgr="Менеджер справочников",e.meta_doc_mgr="Менеджер документов",e.meta_enn_mgr="Менеджер перечислений",e.meta_ireg_mgr="Менеджер регистров сведений",e.meta_areg_mgr="Менеджер регистров накопления",e.meta_accreg_mgr="Менеджер регистров бухгалтерии",e.meta_dp_mgr="Менеджер обработок",e.meta_task_mgr="Менеджер задач",e.meta_bp_mgr="Менеджер бизнес-процессов",e.meta_reports_mgr="Менеджер отчетов",e.meta_cacc_mgr="Менеджер планов счетов",e.meta_cch_mgr="Менеджер планов видов характеристик",e.meta_extender="Модификаторы объектов и менеджеров",e.modified_close="Объект изменен<br/>Закрыть без сохранения?",e.mandatory_title="Обязательный реквизит",e.mandatory_field="Укажите значение реквизита '%1'",e.no_metadata="Не найдены метаданные объекта '%1'",e.no_selected_row="Не выбрана строка табличной части '%1'",e.no_dhtmlx="Библиотека dhtmlx не загружена",e.not_implemented="Не реализовано в текущей версии",e.offline_request="Запрос к серверу в автономном режиме",e.onbeforeunload="Окнософт: легкий клиент. Закрыть программу?",e.order_sent_title="Подтвердите отправку заказа",e.order_sent_message="Отправленный заказ нельзя изменить.<br/>После проверки менеджером<br/>он будет запущен в работу",e.report_error="<i class='fa fa-exclamation-circle fa-2x fa-fw'></i> Ошибка",e.report_prepare="<i class='fa fa-spinner fa-spin fa-2x fa-fw'></i> Подготовка отчета",e.report_need_prepare="<i class='fa fa-info fa-2x fa-fw'></i> Нажмите 'Сформировать' для получения отчета",e.report_need_online="<i class='fa fa-plug fa-2x fa-fw'></i> Нет подключения. Отчет недоступен в автономном режиме",e.request_title="Запрос регистрации",e.request_message="Заявка зарегистрирована. После обработки менеджером будет сформировано ответное письмо",e.select_from_list="Выбор из списка",e.select_grp="Укажите группу, а не элемент",e.select_elm="Укажите элемент, а не группу",e.select_file_import="Укажите файл для импорта",e.srv_overload="Сервер перегружен",e.sub_row_change_disabled="Текущая строка подчинена продукции.<br/>Строку нельзя изменить-удалить в документе<br/>только через построитель",e.sync_script="Обновление скриптов приложения:",e.sync_data="Синхронизация с сервером выполняется:<br />* при первом старте программы<br /> * при обновлении метаданных<br /> * при изменении цен или технологических справочников",e.sync_break="Прервать синхронизацию",e.sync_no_data="Файл не содержит подходящих элементов для загрузки",e.tabular_will_cleared="Табличная часть '%1' будет очищена. Продолжить?",e.unsupported_browser_title="Браузер не поддерживается",e.unsupported_browser="Несовместимая версия браузера<br/>Рекомендуется Google Chrome",e.supported_browsers="Рекомендуется Chrome, Safari или Opera",e.unsupported_mode_title="Режим не поддерживается",e.unsupported_mode="Программа не установлена<br/> в <a href='"+e.store_url_od+"'>приложениях Google Chrome</a>",e.unknown_error="Неизвестная ошибка в функции '%1'",e.value="Значение"}(K.msg);var Y;s.prototype.__define({family_name:{get:function(){return K.msg["meta_"+this.class_name.split(".")[0]+"_mgr"].replace(K.msg.meta_mgr+" ","")}},table_name:{get:function(){return this.class_name.replace(".","_")}},find_rows:{value:function(e,t){return K._find_rows.call(this,this.by_ref,e,t)}},extra_fields:{value:function(e){var t=K.cat.destinations||K.cch.destinations,n=Y.class_name_to_1c(this.class_name).replace(".","_"),r=[];return t&&t.find_rows({predefined_name:n},function(e){var t=e.extra_fields||e.ДополнительныеРеквизиты;return t&&t.each(function(e){e._deleted||e.ПометкаУдаления||r.push(e.property||e.Свойство)}),!1}),r}},extra_properties:{value:function(e){return[]}},obj_constructor:{value:function(e){var t=this.class_name.split("."),n=t[0].charAt(0).toUpperCase()+t[0].substr(1)+t[1].charAt(0).toUpperCase()+t[1].substr(1);return e?n+e.charAt(0).toUpperCase()+e.substr(1)+"Row":n}},sync_grid:{value:function(e,t){function n(e){return new Promise(function(n,r){"string"==typeof e?("{"==e.substr(0,1)&&(e=JSON.parse(e)),t&&t.parse?(t.xmlFileUrl="exec",t.parse(e,function(){n(e)},"xml")):n(e)):t instanceof dhtmlXTreeView&&t.loadStruct?t.loadStruct(e,function(){n(e)}):n(e)})}var r=this;return function(){if("function"==typeof e.custom_selection)return e.custom_selection(e);if("ram"==r.cachable||"doc_ram"==r.cachable){if("get_tree"==e.action)return K.wsql.promise(r.get_sql_struct(e),[]).then(K.iface.data_to_tree);if("get_selection"==e.action)return K.wsql.promise(r.get_sql_struct(e),[]).then(function(t){return K.iface.data_to_grid.call(r,t,e)})}else if(0==r.cachable.indexOf("doc")||0==r.cachable.indexOf("remote")){if("get_tree"==e.action)return r.pouch_tree(e);if("get_selection"==e.action)return r.pouch_selection(e)}else{if("get_tree"==e.action)return r.rest_tree(e);if("get_selection"==e.action)return r.rest_selection(e)}}().then(n).catch(K.record_log)}},get_option_list:{value:function(e,t){function n(t){return K.utils.is_equal(t.value,e)&&(t.selected=!0),t}var r,a,i,o=this,s=[];if(t.presentation&&(r=o.metadata().input_by_string)&&(a=t.presentation.like,delete t.presentation,t.or=[],r.forEach(function(e){i={},i[e]={like:a},t.or.push(i)})),-1!=o.cachable.indexOf("ram")||t&&t._local)return o.find_rows(t,function(e){s.push(n({text:e.presentation,value:e.ref}))}),s.sort(function(e,t){return e.text<t.text?-1:e.text>t.text?1:0}),Promise.resolve(s);if("e1cib"!=o.cachable)return o.pouch_find_rows(t).then(function(e){return e.forEach(function(e){s.push(n({text:e.presentation,value:e.ref}))}),s});var l={selection:t,top:t._top},u=o instanceof y||o instanceof b;return delete t._top,u?l.fields=["ref","date","number_doc"]:o.metadata().main_presentation_name?l.fields=["ref","name"]:l.fields=["ref","id"],H.load_array(l,o).then(function(e){return e.forEach(function(e){s.push(n({text:u?e.number_doc+" от "+K.moment(e.date).format(K.moment._masks.ldt):e.name||e.id,value:e.ref}))}),s})}},tabular_captions:{value:function(e,t){}},get_property_grid_xml:{value:function(e,t,n){var r,a,i,o,s,l,u,_=this,c="<rows>",f=function(e,t){l=K.utils.is_data_obj(e)?e.presentation:e,t.type.is_ref||(t.type.date_part?l=K.moment(l).format(K.moment._masks[t.type.date_part]):"boolean"==t.type.types[0]&&(l=l?"1":"0"))},d=function(e){s=Y.control_by_type(i.type,e),f(e,i)},p=function(e,r){if(r){var a=e.property||e.param||e.Параметр||e.Свойство,p=void 0!=e.value?e.value:e.Значение;a.empty()?(u=r+"|empty",s="ro",l="",i={synonym:"?"}):(i={synonym:a.presentation,type:a.type},u=r+"|"+a.ref,d(p),"edn"==s&&(s="calck"),a.mandatory&&(s+='" class="cell_mandatory'))}else if("object"==typeof e)u=e.id,i=n&&n.metadata&&n.metadata[u],i?e.synonym&&(i.synonym=e.synonym):i={synonym:e.synonym},s=e.type,l="",e.hasOwnProperty("txt")?l=e.txt:void 0!==(o=t[u])&&f(o,i.type?i:Y.get(_.class_name,u));else if(n&&n.metadata&&void 0!==(i=n.metadata[e]))u=e,d(o=t[e]);else{if(void 0===(o=t[e]))return;if(!(i=Y.get(_.class_name,u=e)))return;d(o)}c+='<row id="'+u+'"><cell>'+(i.synonym||i.name)+'</cell><cell type="'+s+'">'+l+"</cell></row>"};!function(){if(!e)if(i=_.metadata(),i.form&&i.form.obj&&i.form.obj.head)e=i.form.obj.head;else{if(e={" ":[]},t instanceof q?(i.code_length&&e[" "].push("id"),i.main_presentation_name&&e[" "].push("name")):t instanceof A&&(e[" "].push("number_doc"),e[" "].push("date")),!t.is_folder)for(r in i.fields)"predefined_name"==r||i.fields[r].hide||e[" "].push(r);i.tabular_sections&&i.tabular_sections.extra_fields&&(e["Дополнительные реквизиты"]=[])}}();for(r in e){" "!=r&&(c+='<row open="1"><cell>'+r+"</cell>");for(a in e[r])p(e[r][a]);if(n&&r==n.title&&t[n.ts]){var h,m=_.extra_fields(t),y="property,param,Свойство,Параметр".split(","),g=t[n.ts]._owner._metadata.tabular_sections[t[n.ts]._name].fields;y.some(function(e){if(g[e])return h=e,!0})&&(t[n.ts].forEach(function(e){var t=m.indexOf(e[h]);-1!=t&&m.splice(t,1)}),m.forEach(function(e){t[n.ts].add()[h]=e})),t[n.ts].find_rows(n.selection,function(e){p(e,n.ts)})}" "!=r&&(c+="</row>")}return c+="</rows>"}},print:{value:function(e,t,n){function r(e){n&&n.progressOff&&n.progressOff(),e&&e.focus()}if(n&&n.progressOn&&n.progressOn(),setTimeout(r,3e3),this._printing_plates[t]instanceof E&&(t=this._printing_plates[t]),t instanceof E&&t.execute)return e instanceof E?t.execute(e).then(r):this.get(e,!0,!0).then(t.execute.bind(t)).then(r);var a={};return K.ajax.default_attr(a,K.job_prm.irest_url()),a.url+=this.rest_name+"(guid'"+K.utils.fix_guid(e)+"')/Print(model="+t+", browser_uid="+K.wsql.get_user_param("browser_uid")+")",K.ajax.get_and_show_blob(a.url,a,"get").then(r)}},printing_plates:{value:function(){var e={},t=this;return t._printing_plates||(t.metadata().printing_plates?t._printing_plates=t.metadata().printing_plates:("ram"==t.metadata().cachable||t.metadata().cachable&&0==t.metadata().cachable.indexOf("doc"))&&(t._printing_plates={})),!t._printing_plates&&K.ajax.authorized?(K.ajax.default_attr(e,K.job_prm.irest_url()),e.url+=t.rest_name+"/Print()",K.ajax.get_ex(e.url,e).then(function(e){return t._printing_plates=JSON.parse(e.response),t._printing_plates}).catch(function(){}).then(function(e){return e||(t._printing_plates={})})):Promise.resolve(t._printing_plates)}}}),l._extend(s),l.prototype.__define({push:{value:function(e,t){t&&t!=e.ref?(delete this.by_ref[e.ref],this.by_ref[t]=e):this.by_ref[e.ref]=e}},each:{value:function(e){for(var t in this.by_ref)if(t&&t!=K.utils.blank.guid&&1==e.call(this,this.by_ref[t]))break}},forEach:{value:function(e){return this.each.call(this,e)}},get:{value:function(e,t,n){var r=this.by_ref[e]||this.by_ref[e=K.utils.fix_guid(e)];if(!r){if(n&&!t)return;r=new(K[this.obj_constructor()])(e,this,!0)}return!1===t?r:void 0===t&&e===K.utils.blank.guid?r:r.is_new()?r.load():t?Promise.resolve(r):r}},create:{value:function(e,t,n){e&&"object"==typeof e||(e={}),e.ref&&K.utils.is_guid(e.ref)&&!K.utils.is_empty_guid(e.ref)||(e.ref=K.utils.generate_guid());var r=this.by_ref[e.ref];if(!r)if(r=new(K[this.obj_constructor()])(e,this),!t&&e.ref&&e.presentation&&2==Object.keys(e).length);else{r instanceof A&&r.date==K.utils.blank.date&&(r.date=new Date);var a=this.handle_event(r,"after_create");if(this instanceof y||this instanceof g||this instanceof b?r.number_doc||r.new_number_doc():!r.id&&r._metadata.code_length&&r.new_number_doc(),!1===a)return Promise.resolve(r);if("object"==typeof a&&a.then)return a;if("e1cib"==this.cachable&&t){var i={};return K.ajax.default_attr(i,K.job_prm.irest_url()),i.url+=this.rest_name+"/Create()",K.ajax.get_ex(i.url,i).then(function(e){return r._mixin(JSON.parse(e.response),void 0,["ref"])})}}return n?r:Promise.resolve(r)}},unload_obj:{value:function(e){delete this.by_ref[e],this.alatable.some(function(t,n,r){if(t.ref==e)return r.splice(n,1),!0})}},find:{value:function(e,t){return K._find(this.by_ref,e,t)}},load_array:{value:function(e,t){for(var n,r,a=[],i=0;i<e.length;i++){if(n=K.utils.fix_guid(e[i]),r=this.by_ref[n])(r.is_new()||t)&&(r._mixin(e[i]),r._set_loaded());else{if("update_only"==t)continue;r=new(K[this.obj_constructor()])(e[i],this),t&&r._set_loaded()}a.push(r)}return a}},first_folder:{value:function(e){for(var t in this.by_ref){var n=this.by_ref[t];if(n.is_folder&&(!e||K.utils.is_equal(e,n.owner)))return n}return this.get()}},get_sql_struct:{value:function(e){var t,n,r=this,a=r.metadata(),i={},o=0,s=e&&e.action?e.action:"create_table";return"create_table"==s?i=function(){var i="CREATE TABLE IF NOT EXISTS ";if(e&&e.postgres){i+=r.table_name+" (ref uuid PRIMARY KEY NOT NULL, _deleted boolean",r instanceof y?i+=", posted boolean, date timestamp with time zone, number_doc character(11)":(a.code_length&&(i+=", id character("+a.code_length+")"),i+=", name character varying(50), is_folder boolean");for(t in a.fields)t.length>30?a.fields[t].short_name?n=a.fields[t].short_name:(o++,n=t[0]+o+t.substr(t.length-27)):n=t,i+=", "+n+Y.sql_type(r,t,a.fields[t].type,!0)+Y.sql_composite(a.fields,t,n,!0);for(t in a.tabular_sections)i+=", ts_"+t+" JSON"}else{i+="`"+r.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `_deleted` BOOLEAN",i+=r instanceof y?", posted boolean, date Date, number_doc CHAR":", id CHAR, name CHAR, is_folder BOOLEAN";for(t in a.fields)i+=Y.sql_mask(t)+Y.sql_type(r,t,a.fields[t].type)+Y.sql_composite(a.fields,t);for(t in a.tabular_sections)i+=", `ts_"+t+"` JSON"}return i+=")"}():-1!=["insert","update","replace"].indexOf(s)?i[r.table_name]=function(){var e=["ref","_deleted"],n="INSERT INTO `"+r.table_name+"` (ref, `_deleted`",i="(?";"cat"==r.class_name.substr(0,3)?(n+=", id, name, is_folder",e.push("id"),e.push("name"),e.push("is_folder")):"doc"==r.class_name.substr(0,3)&&(n+=", posted, date, number_doc",e.push("posted"),e.push("date"),e.push("number_doc"));for(t in a.fields)n+=Y.sql_mask(t),e.push(t);for(t in a.tabular_sections)n+=", `ts_"+t+"`",e.push("ts_"+t);for(n+=") VALUES ",t=1;t<e.length;t++)i+=", ?";return i+=")",n+=i,{sql:n,fields:e,values:i}}():"select"==s?i="SELECT * FROM `"+r.table_name+"` WHERE ref = ?":"select_all"==s?i="SELECT * FROM `"+r.table_name+"`":"delete"==s?i="DELETE FROM `"+r.table_name+"` WHERE ref = ?":"drop"==s?i="DROP TABLE IF EXISTS `"+r.table_name+"`":"get_tree"==s?i=!e.filter||e.filter.is_folder?"SELECT ref, parent, name as presentation FROM `"+r.table_name+"` WHERE is_folder order by parent, name":"SELECT ref, parent, name as presentation FROM `"+r.table_name+"` order by parent, name":"get_selection"==s&&(i=function(){var t,n=!e.parent,i=e.parent||K.utils.blank.guid,o=e.initial_value||K.utils.blank.guid,s=e.filter||"",l=K.utils.blank.guid;!function(){function u(t){t&&(l=e.set_parent=t.parent.ref,i=l,n=!1),s&&-1==s.indexOf("%")&&(s="%"+s+"%")}a.has_owners&&(t=e.owner,e.selection&&"function"!=typeof e.selection&&e.selection.forEach(function(e){e.owner&&(t="object"==typeof e.owner?e.owner.valueOf():e.owner,delete e.owner)}),t||(t=K.utils.blank.guid)),o!=K.utils.blank.guid&&n&&a.hierarchical?u(r.get(o,!1)):u()}();var u;return u=r.sql_selection_list_flds?r.sql_selection_list_flds(o):("SELECT %2, case when _t_.ref = '"+o+"' then 0 else 1 end as is_initial_value FROM `"+r.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",function(){var e=[],t="_t_.ref, _t_.`_deleted`";return a.form&&a.form.selection?a.form.selection.fields.forEach(function(t){e.push(t)}):r instanceof y?(e.push("posted"),e.push("date"),e.push("number_doc")):(a.hierarchical&&a.group_hierarchy?e.push("is_folder"):e.push("0 as is_folder"),r instanceof m?(e.push("id"),e.push("name as presentation")):a.main_presentation_name?e.push("name as presentation"):a.code_length?e.push("id as presentation"):e.push("'...' as presentation"),a.has_owners&&e.push("owner"),a.code_length&&e.push("id")),e.forEach(function(e){-1!=e.indexOf(" as ")?t+=", "+e:t+=Y.sql_mask(e,!0)}),t}()).replace("%j",function(){var e,t="";if(a.form&&a.form.selection)for(var n in a.form.selection.fields)-1!=a.form.selection.fields[n].indexOf(" as ")&&-1==a.form.selection.fields[n].indexOf("_t_.")&&(e=a.form.selection.fields[n].split(" as "),e[0]=e[0].split("."),e[0].length>1&&(t&&(t+="\n"),t+="left outer join "+e[0][0]+" on "+e[0][0]+".ref = _t_."+e[1]));return t}()),u.replace("%3",function(){var o;return o=r instanceof m?" WHERE ("+(s?0:1):a.hierarchical?a.has_owners?" WHERE ("+(n||s?1:0)+" OR _t_.parent = '"+i+"') AND ("+(t==K.utils.blank.guid?1:0)+" OR _t_.owner = '"+t+"') AND ("+(s?0:1):" WHERE ("+(n||s?1:0)+" OR _t_.parent = '"+i+"') AND ("+(s?0:1):a.has_owners?" WHERE ("+(t==K.utils.blank.guid?1:0)+" OR _t_.owner = '"+t+"') AND ("+(s?0:1):" WHERE ("+(s?0:1),r.sql_selection_where_flds?o+=r.sql_selection_where_flds(s):r instanceof y?o+=" OR _t_.number_doc LIKE '"+s+"'":((a.main_presentation_name||r instanceof m)&&(o+=" OR _t_.name LIKE '"+s+"'"),a.code_length&&(o+=" OR _t_.id LIKE '"+s+"'")),o+=") AND (_t_.ref != '"+K.utils.blank.guid+"')",e.selection&&("function"==typeof e.selection||e.selection.forEach(function(e){for(var t in e)if("function"==typeof e[t])o+="\n AND "+e[t](r,t)+" ";else if(a.fields.hasOwnProperty(t)||"ref"===t)if(!0===e[t])o+="\n AND _t_."+t+" ";else if(!1===e[t])o+="\n AND (not _t_."+t+") ";else if("object"==typeof e[t])if(K.utils.is_data_obj(e[t])||K.utils.is_guid(e[t]))o+="\n AND (_t_."+t+" = '"+e[t]+"') ";else{var n=Object.keys(e[t]),i=e[t][n[0]],s=a.fields[t];s&&s.type.is_ref&&Y.value_mgr({},t,s.type,!0,i),"not"==n[0]?o+="\n AND (not _t_."+t+" = '"+i+"') ":"in"==n[0]?o+="\n AND (_t_."+t+" in ("+e[t].in.reduce(function(e,t){return e&&(e+=","),e+="number"==typeof t?t.toString():"'"+t+"'"},"")+")) ":o+="\n AND (_t_."+t+" = '"+i+"') "}else"string"==typeof e[t]?o+="\n AND (_t_."+t+" = '"+e[t]+"') ":o+="\n AND (_t_."+t+" = "+e[t]+") ";else"is_folder"==t&&a.hierarchical&&a.group_hierarchy})),o}()).replace("%4",function(){return r instanceof m?"ORDER BY id":a.hierarchical?a.group_hierarchy?"ORDER BY _t_.is_folder desc, is_initial_value, presentation":"ORDER BY _t_.parent desc, is_initial_value, presentation":"ORDER BY is_initial_value, presentation"}())}()),i}},caption_flds:{value:function(e){var t=e.metadata||this.metadata(),n=[],r="";if(t.form&&t.form.selection?n=t.form.selection.cols:this instanceof y?(n.push(new Col_struct("date","160","ro","left","server","Дата")),n.push(new Col_struct("number_doc","140","ro","left","server","Номер")),t.fields.note&&n.push(new Col_struct("note","*","ro","left","server",t.fields.note.synonym)),t.fields.responsible&&n.push(new Col_struct("responsible","*","ro","left","server",t.fields.responsible.synonym))):this instanceof m?(n.push(new Col_struct("id","140","ro","left","server","Код")),n.push(new Col_struct("presentation","*","ro","left","server","Наименование"))):n.push(new Col_struct("presentation","*","ro","left","server","Наименование")),e.get_header&&n.length){r="<head>";for(var a in n)r+='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>'.replace("%1",n[a].id).replace("%2",n[a].width).replace("%3",n[a].type).replace("%4",n[a].align).replace("%5",n[a].sort).replace("%6",n[a].caption);r+="</head>"}return{head:r,acols:n}}},load_cached_server_array:{value:function(e,t){var n,r=[],a=this,i=t?{class_name:a.class_name,rest_name:t}:a,o=!t;if(e.forEach(function(e){(!(n=a.get(e.ref||e,!1,!0))||o&&n.is_new())&&r.push(e.ref||e)}),r.length){var s={url:"",selection:{ref:{in:r}}};return o&&(s.fields=["ref"]),K.rest.build_select(s,i),K.ajax.get_ex(s.url,s).then(function(t){var n=JSON.parse(t.response);if(o)n=n.value;else{n=n.data;for(var r in n)!n[r].ref&&n[r].id&&(n[r].ref=n[r].id),n[r].Код&&(n[r].id=n[r].Код,delete n[r].Код),n[r]._not_set_loaded=!0}return a.load_array(n),e})}return Promise.resolve(e)}},predefined:{value:function(e){return this._predefined||(this._predefined={}),this._predefined[e]||(this._predefined[e]=this.get(),this.find_rows({predefined_name:e},function(t){return this._predefined[e]=t,!1})),this._predefined[e]}}}),u._extend(s),u.prototype.__define({create:{value:function(e){return new(K[this.obj_constructor()])(e||{},this)}},unload_obj:{value:function(){}}}),_._extend(l),_.prototype.__define({get:{value:function(e){if(e instanceof N)return e;e&&e!=K.utils.blank.guid||(e="_");var t=this[e];return t||(t=new N({name:e},this)),t}},push:{value:function(e,t){this.__define(t,{value:e})}},each:{value:function(e){this.alatable.forEach(function(t){t.ref&&"_"!=t.ref&&t.ref!=K.utils.blank.guid&&e.call(this[t.ref])}.bind(this))}},get_sql_struct:{value:function(e){var t="CREATE TABLE IF NOT EXISTS ",n=e&&e.action?e.action:"create_table";return e&&e.postgres?"create_table"==n?t+=this.table_name+" (ref character varying(255) PRIMARY KEY NOT NULL, sequence INT, synonym character varying(255))":-1!=["insert","update","replace"].indexOf(n)?(t={},t[this.table_name]={sql:"INSERT INTO "+this.table_name+" (ref, sequence, synonym) VALUES ($1, $2, $3)",fields:["ref","sequence","synonym"],values:"($1, $2, $3)"}):"delete"==n&&(t="DELETE FROM "+this.table_name+" WHERE ref = $1"):"create_table"==n?t+="`"+this.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, sequence INT, synonym CHAR)":-1!=["insert","update","replace"].indexOf(n)?(t={},t[this.table_name]={sql:"INSERT INTO `"+this.table_name+"` (ref, sequence, synonym) VALUES (?, ?, ?)",fields:["ref","sequence","synonym"],values:"(?, ?, ?)"}):"delete"==n&&(t="DELETE FROM `"+this.table_name+"` WHERE ref = ?"),t}},get_option_list:{value:function(e,t){function n(t){return K.utils.is_equal(t.value,e)&&(t.selected=!0),t}var r,a=[],i="";if(t)for(var o in t)"_"!=o.substr(0,1)&&("ref"==o?r=t[o].hasOwnProperty("in")?t[o].in:t[o]:i=t[o]);return"object"==typeof i&&(i=i.like?i.like:""),i=i.toLowerCase(),this.alatable.forEach(function(e){if(!i||e.synonym&&-1!=e.synonym.toLowerCase().indexOf(i)){if(r)if(Array.isArray(r)){if(!r.some(function(t){return t.name==e.ref||t.ref==e.ref||t==e.ref}))return}else if(r.name!=e.ref&&r.ref!=e.ref&&r!=e.ref)return;a.push(n({text:e.synonym||"",value:e.ref}))}}),a.sort(function(e,t){return e.text<t.text?-1:e.text>t.text?1:0}),Promise.resolve(a)}}}),c._extend(s),c.prototype.__define({get_sql_struct:{value:function(e){function t(){var t="SELECT * FROM `"+r.table_name+"` WHERE ",n=!0;e._values=[];for(var i in a.dimensions)n?n=!1:t+=" and ",t+="`"+i+"`=?",e._values.push(e[i]);return n&&(t+="1"),t}var n,r=this,a=r.metadata(),i={},o=e&&e.action?e.action:"create_table";return"create_table"==o?i=function(){var t="CREATE TABLE IF NOT EXISTS ",i=!0;if(e&&e.postgres){t+=r.table_name+" (",a.splitted&&(t+="zone integer",i=!1);for(n in a.dimensions)i?(t+=n,i=!1):t+=", "+n,t+=Y.sql_type(r,n,a.dimensions[n].type,!0)+Y.sql_composite(a.dimensions,n,"",!0);for(n in a.resources)t+=", "+n+Y.sql_type(r,n,a.resources[n].type,!0)+Y.sql_composite(a.resources,n,"",!0);for(n in a.attributes)t+=", "+n+Y.sql_type(r,n,a.attributes[n].type,!0)+Y.sql_composite(a.attributes,n,"",!0);t+=", PRIMARY KEY (",i=!0,a.splitted&&(t+="zone",i=!1);for(n in a.dimensions)i?(t+=n,i=!1):t+=", "+n}else{t+="`"+r.table_name+"` (ref CHAR PRIMARY KEY NOT NULL, `_deleted` BOOLEAN";for(n in a.dimensions)t+=Y.sql_mask(n)+Y.sql_type(r,n,a.dimensions[n].type);for(n in a.resources)t+=Y.sql_mask(n)+Y.sql_type(r,n,a.resources[n].type)
;for(n in a.attributes)t+=Y.sql_mask(n)+Y.sql_type(r,n,a.attributes[n].type)}return t+=")"}():o in{insert:"",update:"",replace:""}?i[r.table_name]=function(){var e="INSERT OR REPLACE INTO `"+r.table_name+"` (",t=[],i=!0;for(n in a.dimensions)i?(e+=n,i=!1):e+=", "+n,t.push(n);for(n in a.resources)e+=", "+n,t.push(n);for(n in a.attributes)e+=", "+n,t.push(n);for(e+=") VALUES (?",n=1;n<t.length;n++)e+=", ?";return e+=")",{sql:e,fields:t}}():"select"==o?i=t():"select_all"==o?i=t():"delete"==o?i="DELETE FROM `"+r.table_name+"` WHERE ref = ?":"drop"==o?i="DROP TABLE IF EXISTS `"+r.table_name+"`":"get_selection"==o&&(i=function(){var t=e.filter||"";t&&-1==t.indexOf("%")&&(t="%"+t+"%");var n;return n=r.sql_selection_list_flds?r.sql_selection_list_flds():("SELECT %2 FROM `"+r.table_name+"` AS _t_ %j %3 %4 LIMIT 300").replace("%2",function(){var e=[],t="_t_.ref";if(a.form&&a.form.selection)a.form.selection.fields.forEach(function(t){e.push(t)});else for(var n in a.dimensions)e.push(n);return e.forEach(function(e){-1!=e.indexOf(" as ")?t+=", "+e:t+=Y.sql_mask(e,!0)}),t}()).replace("%j",function(){var e,t="";if(a.form&&a.form.selection)for(var n in a.form.selection.fields)-1!=a.form.selection.fields[n].indexOf(" as ")&&-1==a.form.selection.fields[n].indexOf("_t_.")&&(e=a.form.selection.fields[n].split(" as "),e[0]=e[0].split("."),e[0].length>1&&(t&&(t+="\n"),t+="left outer join "+e[0][0]+" on "+e[0][0]+".ref = _t_."+e[1]));return t}()),n.replace("%3",function(){var n=" WHERE ("+(t?0:1);return r.sql_selection_where_flds&&(n+=r.sql_selection_where_flds(t)),n+=")",e.selection&&("function"==typeof e.selection||e.selection.forEach(function(e){for(var t in e)if("function"==typeof e[t])n+="\n AND "+e[t](r,t)+" ";else if(a.fields.hasOwnProperty(t))if(!0===e[t])n+="\n AND _t_."+t+" ";else if(!1===e[t])n+="\n AND (not _t_."+t+") ";else if("object"==typeof e[t])if(K.utils.is_data_obj(e[t]))n+="\n AND (_t_."+t+" = '"+e[t]+"') ";else{var i=Object.keys(e[t]),o=e[t][i[0]],s=a.fields[t];s&&s.type.is_ref&&Y.value_mgr({},t,s.type,!0,o),"not"==i[0]?n+="\n AND (not _t_."+t+" = '"+o+"') ":n+="\n AND (_t_."+t+" = '"+o+"') "}else"string"==typeof e[t]?n+="\n AND (_t_."+t+" = '"+e[t]+"') ":n+="\n AND (_t_."+t+" = "+e[t]+") ";else"is_folder"==t&&a.hierarchical&&a.group_hierarchy})),n}()).replace("%4","")}()),i}},get_ref:{value:function(e){if(e instanceof C&&(e=e._obj),e.ref)return e.ref;var t="",n=this.metadata().dimensions;for(var r in n)t+=t?"¶":"",n[r].type.is_ref?t+=K.utils.fix_guid(e[r]):!e[r]&&n[r].type.digits?t+="0":n[r].date_part?t+=K.moment(e[r]||K.utils.blank.date).format(K.moment.defaultFormatUtc):void 0!=e[r]?t+=String(e[r]):t+="$";return t}},caption_flds:{value:function(e){var t=e.metadata||this.metadata(),n='<column id="%1" width="%2" type="%3" align="%4" sort="%5">%6</column>',r=[],a="";if(t.form&&t.form.selection)r=t.form.selection.cols;else for(var i in t.dimensions)r.push(new Col_struct(i,"*","ro","left","server",t.dimensions[i].synonym));if(e.get_header&&r.length){a="<head>";for(var o in r)a+=n.replace("%1",r[o].id).replace("%2",r[o].width).replace("%3",r[o].type).replace("%4",r[o].align).replace("%5",r[o].sort).replace("%6",r[o].caption);a+="</head>"}return{head:a,acols:r}}},create:{value:function(e){e&&"object"==typeof e||(e={});var t=this.by_ref[e.ref];if(!t){t=new(K[this.obj_constructor()])(e,this);var n=this.handle_event(t,"after_create");if(!1===n)return Promise.resolve(t);if("object"==typeof n&&n.then)return n}return Promise.resolve(t)}}}),f._extend(c),f.prototype.slice_first=function(e){},f.prototype.slice_last=function(e){},d._extend(c),p._extend(l),p.prototype.by_name=function(e){var t;return this.find_rows({name:e},function(e){return t=e,!1}),t||(t=this.get()),t},p.prototype.by_id=function(e){var t;return this.find_rows({id:e},function(e){return t=e,!1}),t||(t=this.get()),t},p.prototype.path=function(e){var t,n=[];if(t=e instanceof E?e:this.get(e,!1,!0),t&&n.push({ref:t.ref,presentation:t.presentation}),t&&this.metadata().hierarchical)for(;;){if(t=t.parent,t.empty())break;n.push({ref:t.ref,presentation:t.presentation})}return n},h._extend(p),m._extend(p),y._extend(l),g._extend(p),b._extend(p),v._extend(f),w._extend(p),x._extend(p),j._extend(p),O.prototype.toString=function(){return"Табличная часть "+this._owner.class_name+"."+this._name},O.prototype.get=function(e){return this._obj[e]?this._obj[e]._row:null},O.prototype.count=function(){return this._obj.length},O.prototype.clear=function(e,t){return t?this.find_rows(t).forEach(function(e){e._row._owner.del(e.row-1,!0)}):this._obj.length=0,e||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),this},O.prototype.del=function(e,t){var n,r=this._obj;if(void 0!==e){if("number"==typeof e)n=e;else if(r[e.row-1]._row===e)n=e.row-1;else for(var a in r)if(r[a]._row===e){n=Number(a),delete r[a]._row;break}void 0!=n&&(r.splice(n,1),r.forEach(function(e,t){e.row=t+1}),t||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),this._owner._data._modified=!0)}},O.prototype.find=function(e,t){var n=K._find(this._obj,e,t);if(n)return n._row},O.prototype.find_rows=function(e,t){var n=this,r=t?function(e){return t.call(n,e._row)}:null;return K._find_rows.call(n,n._obj,e,r)},O.prototype.swap=function(e,t){var n=this._obj[e];this._obj[e]=this._obj[t],this._obj[t]=n,this._obj[e].row=e+1,this._obj[t].row=t+1,this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name})},O.prototype.add=function(e,t){var n=new(K[this._owner._manager.obj_constructor(this._name)])(this);e||(e={});for(var r in n._metadata.fields)n[r]=e[r]||"";return n._obj.row=this._obj.push(n._obj),n._obj.__define("_row",{value:n,enumerable:!1}),t||this._owner._data._silent||Object.getNotifier(this._owner).notify({type:"rows",tabular:this._name}),e=null,this._owner._data._modified=!0,n},O.prototype.each=function(e){var t=this;t._obj.forEach(function(n){return e.call(t,n._row)})},O.prototype.forEach=O.prototype.each,O.prototype.group_by=function(e,t){try{var n=this.aggregate(e,t,"SUM",!0);return this.clear(!0).load(n)}catch(e){}},O.prototype.sort=function(e){"string"==typeof e&&(e=e.split(","));var t="select * from ? order by ",n=!0;e.forEach(function(e){e=e.trim().replace(/\s{1,}/g," ").split(" "),n?n=!1:t+=", ",t+="`"+e[0]+"`",e[1]&&(t+=" "+e[1])});try{return n=K.wsql.alasql(t,[this._obj]),this.clear(!0).load(n)}catch(e){K.record_log(e)}},O.prototype.aggregate=function(e,t,n,r){if("string"==typeof e&&(e=e.split(",")),"string"==typeof t&&(t=t.split(",")),n||(n="sum"),!e.length&&1==t.length&&"sum"==n)return this._obj.reduce(function(e,n,r,a){return e+n[t[0]]},0);var a,i=!0;t.forEach(function(e){a?a+=", "+n+"(`"+e+"`) `"+e+"`":a="select "+n+"(`"+e+"`) `"+e+"`"}),e.forEach(function(e){a?a+=", `"+e+"`":a="select `"+e+"`"}),a+=" from ? ",e.forEach(function(e){i?(a+="group by ",i=!1):a+=", ",a+="`"+e+"`"});try{return i=K.wsql.alasql(a,[this._obj]),r||(i=1==t.length?i.length?i[0][t[0]]:0:i.length?i[0]:{}),i}catch(e){K.record_log(e)}},O.prototype.load=function(e){var t,n=this;return n.clear(!0),e instanceof O?t=e._obj:Array.isArray(e)&&(t=e),t&&t.forEach(function(e){n.add(e,!0)}),this._owner._data._silent||Object.getNotifier(n._owner).notify({type:"rows",tabular:n._name}),n},O.prototype.sync_grid=function(e,t){for(var n={rows:[]},r=[],a=0;a<e.getColumnCount();a++)r.push(e.getColumnId(a));if(e.clearAll(),this.find_rows(t,function(e){var t=[];r.forEach(function(n){K.utils.is_data_obj(e[n])?t.push(e[n].presentation):t.push(e[n])}),n.rows.push({id:e.row,data:t})}),e.objBox)try{e.parse(n,"json"),e.callEvent("onGridReconstructed",[])}catch(e){}},O.prototype.toJSON=function(){return this._obj},k.prototype.__define("_metadata",{get:function(){return this._owner._owner._metadata.tabular_sections[this._owner._name]},enumerable:!1}),k.prototype.__define("row",{get:function(){return this._obj.row||0},enumerable:!0}),k.prototype.__define("_clone",{value:function(){return new(K[this._owner._owner._manager.obj_constructor(this._owner._name)])(this._owner)._mixin(this._obj)},enumerable:!1}),k.prototype._getter=E.prototype._getter,k.prototype._setter=function(e,t){if(this._obj[e]!=t&&(t||this._obj[e]!=K.utils.blank.guid)){var n=this._owner._owner;if(n._data._silent||Object.getNotifier(n).notify({type:"row",row:this,tabular:this._owner._name,name:e,oldValue:this._obj[e]}),this._metadata.fields[e].choice_type){var r;r=2==this._metadata.fields[e].choice_type.path.length?this[this._metadata.fields[e].choice_type.path[1]]:n[this._metadata.fields[e].choice_type.path[0]],r&&r.type&&(t=K.utils.fetch_type(t,r.type))}E.prototype.__setter.call(this,e,t),n._data._modified=!0}},E.prototype.__define({valueOf:{value:function(){return this.ref}},toJSON:{value:function(){return this._obj}},toString:{value:function(){return this.presentation}},__notify:{value:function(e){this._data._silent||Object.getNotifier(this).notify({type:"update",name:e,oldValue:this._obj[e]})}},_getter:{value:function(e){var t,n=this._metadata.fields[e].type,r=this._obj?this._obj[e]:"";return"type"==e&&"object"==typeof r?r:"ref"==e?r:n.is_ref?n.digits&&"number"==typeof r?r:n.hasOwnProperty("str_len")&&!K.utils.is_guid(r)?r:(t=Y.value_mgr(this._obj,e,n))?K.utils.is_data_mgr(t)?t.get(r,!1):K.utils.fetch_type(r,t):r?(console.log([e,n,this._obj]),null):void 0:n.date_part?K.utils.fix_date(this._obj[e],!0):n.digits?K.utils.fix_number(this._obj[e],!n.hasOwnProperty("str_len")):"boolean"==n.types[0]?K.utils.fix_boolean(this._obj[e]):this._obj[e]||""}},_getter_ts:{value:function(e){return this._ts_(e)}},_setter:{value:function(e,t){this._obj[e]!=t&&(this.__notify(e),this.__setter(e,t),this._data._modified=!0)}},__setter:{value:function(e,t){var n,r=this._metadata.fields[e].type;"type"==e&&t.types?this._obj[e]=t:"ref"==e?this._obj[e]=K.utils.fix_guid(t):r.is_ref?r.digits&&"number"==typeof t||r.hasOwnProperty("str_len")&&"string"==typeof t&&!K.utils.is_guid(t)?this._obj[e]=t:"boolean"==typeof t&&-1!=r.types.indexOf("boolean")?this._obj[e]=t:(this._obj[e]=K.utils.fix_guid(t),n=Y.value_mgr(this._obj,e,r,!1,t),n?n instanceof _?"string"==typeof t?this._obj[e]=t:t?"object"==typeof t&&(this._obj[e]=t.ref||t.name||""):this._obj[e]="":t&&t.presentation?(!t.type||t instanceof E||delete t.type,n.create(t)):K.utils.is_data_mgr(n)||(this._obj[e]=K.utils.fetch_type(t,n)):"object"!=typeof t&&(this._obj[e]=t)):r.date_part?this._obj[e]=K.utils.fix_date(t,!0):r.digits?this._obj[e]=K.utils.fix_number(t,!r.hasOwnProperty("str_len")):"boolean"==r.types[0]?this._obj[e]=K.utils.fix_boolean(t):this._obj[e]=t}},_setter_ts:{value:function(e,t){var n=this._ts_(e);n instanceof O&&Array.isArray(t)&&n.load(t)}},_metadata:{get:function(){return this._manager.metadata()}},_deleted:{get:function(){return!!this._obj._deleted}},_modified:{get:function(){return!!this._data&&!!this._data._modified}},is_new:{value:function(){return this._data._is_new}},_set_loaded:{value:function(e){return this._manager.push(this,e),this._data._modified=!1,this._data._is_new=!1,this}},mark_deleted:{value:function(e){return this._obj._deleted=!!e,this.save(),this.__notify("_deleted"),this}},ref:{get:function(){return this._obj.ref},set:function(e){this._obj.ref=K.utils.fix_guid(e)},enumerable:!0,configurable:!0},class_name:{get:function(){return this._manager.class_name},set:function(e){this._obj.class_name=e}},empty:{value:function(){return K.utils.is_empty_guid(this._obj.ref)}},load:{value:function(){var e=function(){return e=null,this._data._modified=!1,this}.bind(this);return this.ref==K.utils.blank.guid?(this instanceof q?this.id="000000000":this.number_doc="000000000",Promise.resolve(this)):this._manager.cachable&&"e1cib"!=this._manager.cachable?K.wsql.pouch.load_obj(this).then(e):H.load_obj(this).then(e)}},unload:{value:function(){var e,t=this._obj;this._manager.unload_obj(this.ref),this._observers&&(this._observers.length=0),this._notis&&(this._notis.length=0);for(e in this._metadata.tabular_sections)this[e].clear(!0);for(e in this)this.hasOwnProperty(e)&&delete this[e];for(e in t)delete t[e];["_ts_","_obj","_data"].forEach(function(e){delete this[e]}.bind(this)),e=t=null}},save:{value:function(e,t,n){if(this instanceof A&&"boolean"==typeof e){var r=this.posted;this.posted=e}var a,i=this._manager.handle_event(this,"before_save"),o=function(){return!1===i?this instanceof A&&"boolean"==typeof r&&this.posted!=r&&(this.posted=r):this._data._modified=!1,a=null,i=null,o=null,this}.bind(this);if(!1===i)return Promise.reject(o());if(i instanceof Promise||"object"==typeof i&&i.then)return i.then(o);if(this._metadata.hierarchical&&!this._obj.parent&&(this._obj.parent=K.utils.blank.guid),this instanceof A||this instanceof R||this instanceof S?(K.utils.blank.date==this.date&&(this.date=new Date),this.number_doc||this.new_number_doc()):this.id||this.new_number_doc(),K.msg&&K.msg.show_msg)for(var s in this._metadata.fields)if(this._metadata.fields[s].mandatory&&!this._obj[s])return K.msg.show_msg({title:K.msg.mandatory_title,type:"alert-error",text:K.msg.mandatory_field.replace("%1",this._metadata.fields[s].synonym)}),i=!1,Promise.reject(o());return a=this._manager.cachable&&"e1cib"!=this._manager.cachable?K.wsql.pouch.save_obj:H.save_irest,a(this,{post:e,operational:t,attachments:n}).then(function(e){return e._manager.handle_event(e,"after_save")}).then(o)}},get_attachment:{value:function(e){return this._manager.get_attachment(this.ref,e)}},save_attachment:{value:function(e,t,n){return this._manager.save_attachment(this.ref,e,t,n).then(function(t){return this._attachments||(this._attachments={}),this._attachments[e]&&t.stub||(this._attachments[e]=t),t}.bind(this))}},delete_attachment:{value:function(e){return this._manager.delete_attachment(this.ref,e).then(function(t){return this._attachments&&delete this._attachments[e],t}.bind(this))}},_silent:{value:function(e){"boolean"==typeof e?this._data._silent=e:(this._data._silent=!0,setTimeout(function(){this._data._silent=!1}.bind(this)))}},print:{value:function(e,t){return this._manager.print(this,e,t)}}}),q._extend(E),q.prototype.__define({id:{get:function(){return this._obj.id||""},set:function(e){this.__notify("id"),this._obj.id=e},enumerable:!0},name:{get:function(){return this._obj.name||""},set:function(e){this.__notify("name"),this._obj.name=String(e)},enumerable:!0},presentation:{get:function(){return this.name||this.id?this.name||this.id||this._metadata.obj_presentation||this._metadata.synonym:this._presentation||""},set:function(e){e&&(this._presentation=String(e))}},_hierarchy:{value:function(e){var t=this;if(Array.isArray(e))return e.some(function(e){return t._hierarchy(e)});if(this==e||t.parent==e)return!0;var n=t.parent;return n&&!n.empty()?n._hierarchy(e):e==K.utils.blank.guid}},_children:{get:function(){var e=this,t=[];return this._manager.forEach(function(n){n!=e&&n._hierarchy(e)&&t.push(n)}),t}}}),A._extend(E),A.prototype.__define({posted:{get:function(){return this._obj.posted||!1},set:function(e){this.__notify("posted"),this._obj.posted=K.utils.fix_boolean(e)},enumerable:!0}}),D(A.prototype),P._extend(E),R._extend(q),D(R.prototype),S._extend(q),D(S.prototype),N._extend(E),N.prototype.__define({order:{get:function(){return this._obj.sequence},set:function(e){this._obj.sequence=parseInt(e)},enumerable:!0},name:{get:function(){return this._obj.ref},set:function(e){this._obj.ref=String(e)},enumerable:!0},synonym:{get:function(){return this._obj.synonym||""},set:function(e){this._obj.synonym=String(e)},enumerable:!0},presentation:{get:function(){return this.synonym||this.name}},empty:{value:function(){return!this.ref||"_"==this.ref}}}),C._extend(E),C.prototype.__define({_metadata:{get:function(){var e=this._manager.metadata();return e.fields||(e.fields={}._mixin(e.dimensions)._mixin(e.resources)._mixin(e.attributes)),e}},ref:{get:function(){return this._manager.get_ref(this)},enumerable:!0},presentation:{get:function(){return this._metadata.obj_presentation||this._metadata.synonym}}});var H=K.rest=new T;return s.prototype.__define("rest_name",{get:function(){var e=this.class_name.split(".");return{cat:"Catalog",doc:"Document",ireg:"InformationRegister",areg:"AccumulationRegister",cch:"ChartOfCharacteristicTypes",cacc:"ChartOfAccounts",tsk:"Task",bp:"BusinessProcess"}[e[0]]+"_"+Y.syns_1с(e[1])},enumerable:!1}),s.prototype.rest_tree=function(e){var t,n,r=this,a=r.metadata(),i=[];return K.ajax.default_attr(e,!a.irest&&K.job_prm.rest?K.job_prm.rest_url():K.job_prm.irest_url()),e.url+=this.rest_name+"?allowedOnly=true&$format=json&$top=1000&$select=Ref_Key,DeletionMark,Parent_Key,Description&$filter=IsFolder eq true",K.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(e){for(var r=0;r<e.value.length;r++)n=e.value[r],t={ref:n.Ref_Key,_deleted:n.DeletionMark,parent:n.Parent_Key,presentation:n.Description},i.push(t);return K.iface.data_to_tree(i)})},s.prototype.rest_selection=function(e){if("get_tree"==e.action)return this.rest_tree(e);var t,n,r,a,i,o,s=this,l=s.metadata(),u=[],_=[];return i=function(){var e="$select=Ref_Key,DeletionMark";return l.form&&l.form.selection?l.form.selection.fields.forEach(function(e){u.push(e)}):s instanceof y?(u.push("posted"),u.push("date"),u.push("number_doc")):s instanceof g?(u.push("name as presentation"),u.push("date"),u.push("number_doc"),u.push("completed")):s instanceof b?(u.push("date"),u.push("number_doc"),u.push("started"),u.push("finished")):(l.hierarchical&&l.group_hierarchy?u.push("is_folder"):u.push("0 as is_folder"),l.main_presentation_name?u.push("name as presentation"):l.code_length?u.push("id as presentation"):u.push("'...' as presentation"),l.has_owners&&u.push("owner"),l.code_length&&u.push("id")),u.forEach(function(t){var n;if(-1!=t.indexOf(" as "))if(n=t.split(" as ")[0].split("."),1==n.length)t=n[0];else{if("_t_"!=n[0])return;t=n[1]}"0"!=t&&(r=Y.syns_1с(t),Y.get(s.class_name,t).type.is_ref&&-1==r.indexOf("_Key")&&Y.get(s.class_name,t).type.types.length&&-1==Y.get(s.class_name,t).type.types[0].indexOf("enm.")&&(r+="_Key"),e+=","+r)}),u.push("ref"),u.push("_deleted"),e}(),K.ajax.default_attr(e,!l.irest&&K.job_prm.rest?K.job_prm.rest_url():K.job_prm.irest_url()),e.url+=(l.irest&&l.irest.selection?l.irest.selection:this.rest_name)+"?allowedOnly=true&$format=json&$top=1000&"+i,Y.get(s.class_name,"date")&&(e.date_from||e.date_till)&&(e.url+="&$filter="+H.filter_date("Date",e.date_from,e.date_till),o=!0),l.hierarchical&&e.parent&&(e.url+=o?" and ":"&$filter=",e.url+="Parent_Key eq guid'"+e.parent+"'",o=!0),l.has_owners&&e.owner&&(e.url+=o?" and ":"&$filter=",e.url+="Owner_Key eq guid'"+e.owner+"'",o=!0),e.filter&&(e.url+=o?" and ":"&$filter=",e.url+="$filter eq '"+e.filter+"'",o=!0),K.ajax.get_ex(e.url,e).then(function(e){return JSON.parse(e.response)}).then(function(i){for(var o=0;o<i.value.length;o++)n=i.value[o],t={},u.forEach(function(e){var i;if("ref"==e)return void(t[e]=n.Ref_Key);if(-1!=e.indexOf(" as ")?(i=e.split(" as ")[1],e=e.split(" as ")[0].split("."),e=e[e.length-1]):i=e,r=Y.syns_1с(e),a=Y.get(s.class_name,e))if(-1==r.indexOf("_Key")&&a.type.is_ref&&a.type.types.length&&-1==a.type.types[0].indexOf("enm.")&&(r+="_Key"),a.type.date_part)t[i]=K.moment(n[r]).format(K.moment._masks[a.type.date_part]);else if(a.type.is_ref)if(n[r]&&n[r]!=K.utils.blank.guid){var o=Y.value_mgr(t,e,a.type,!1,n[r]);t[i]=o?o.get(n[r]).presentation:""}else t[i]="";else t[i]=n[r]}),_.push(t);return K.iface.data_to_grid.call(s,_,e)})},f.prototype.rest_slice_last=function(e){e.period||(e.period=K.utils.date_add_day(new Date,1));var t=this,n=t.metadata(),r="Period=datetime'"+K.moment(e.period).format(K.moment._masks.iso)+"'",a="";for(var i in n.dimensions)if(void 0!==e[i]){var o=Y.syns_1с(i),s=n.dimensions[i];-1==o.indexOf("_Key")&&s.type.is_ref&&s.type.types.length&&-1==s.type.types[0].indexOf("enm.")?(o+="_Key",a&&(a+=" and "),a+=o+" eq guid'"+e[i].ref+"'"):(a&&(a+=" and "),s.type.digits?a+=o+" eq "+K.utils.fix_number(e[i]):s.type.date_part?a+=o+" eq datetime'"+K.moment(e[i]).format(K.moment._masks.iso)+"'":a+=o+" eq '"+e[i]+"'")}return a&&(r+=",Condition='"+a+"'"),K.ajax.default_attr(e,K.job_prm.rest_url()),e.url+=this.rest_name+"/SliceLast(%sl)?allowedOnly=true&$format=json&$top=1000".replace("%sl",r),H.ajax_to_data(e,t).then(function(e){return t.load_array(e)})},E.prototype.to_atom=function(e){function t(e){var t=e._metadata.fields,a=e instanceof k?"\n\t<d:":"\n<d:";for(n in t){if(r=t[n],o=Y.syns_1с(n),(s=e[n])instanceof N)s=s.empty()?"":s.name;else if(s instanceof E)-1==o.indexOf("_Key")&&(o+="_Key"),s=s.ref;else if(r.type.date_part)s=s.getFullYear()<1e3?"0001-01-01T00:00:00Z":K.moment(s).format(K.moment.defaultFormatUtc);else if(void 0==s)continue;u+=a+o+">"+s+"</d:"+o+">"}}var n,r,a,i,o,s,l='<entry><category term="StandardODATA.%n" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme"/>\t\t\t\t\n<title type="text"/><updated>%d</updated><author/><summary/><content type="application/xml">\t\t\t\t\n<m:properties xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata">\t\t\t%p\t\t\t\n</m:properties></content></entry>'.replace("%n",this._manager.rest_name).replace("%d",K.moment().format(K.moment.defaultFormatUtc)),u="\n<d:Ref_Key>"+this.ref+"</d:Ref_Key>\n<d:DeletionMark>"+this._deleted+"</d:DeletionMark>";this instanceof A?(u+="\n<d:Date>"+K.moment(this.date).format(K.moment.defaultFormatUtc)+"</d:Date>",u+="\n<d:Number>"+this.number_doc+"</d:Number>"):(this._metadata.main_presentation_name&&(u+="\n<d:Description>"+this.name+"</d:Description>"),this._metadata.code_length&&(u+="\n<d:Code>"+this.id+"</d:Code>"),this._metadata.hierarchical&&this._metadata.group_hierarchy&&(u+="\n<d:IsFolder>"+this.is_folder+"</d:IsFolder>")),t(this);for(a in this._metadata.tabular_sections)this._metadata.tabular_sections[a],o="StandardODATA."+this._manager.rest_name+"_"+Y.syns_1с(a)+"_RowType",i=this[a],i.count()?(u+="\n<d:"+Y.syns_1с(a)+' m:type="Collection('+o+')">',i.each(function(e){u+='\n\t<d:element m:type="'+o+'">',u+="\n\t<d:LineNumber>"+e.row+"</d:LineNumber>",t(e),u+="\n\t</d:element>"}),u+="\n</d:"+Y.syns_1с(a)+">"):u+="\n<d:"+Y.syns_1с(a)+' m:type="Collection('+o+')" />';return l.replace("%p",u)},s.prototype.__define({pouch_load_array:{value:function(e,t){var n={limit:e.length+1,include_docs:!0,keys:e.map(function(e){return this.class_name+"|"+e}.bind(this))};return t&&(n.attachments=!0,n.binary=!0),this.pouch_db.allDocs(n).then(function(e){return K.wsql.pouch.load_changes(e,{})})}},pouch_load_view:{value:function(e){var t,n=this,r=[],a={limit:1e3,include_docs:!0,startkey:n.class_name+"|",endkey:n.class_name+"|￰"};return new Promise(function(i,o){function s(l,u){u?u.rows.length?(a.startkey=u.rows[u.rows.length-1].key,a.skip=1,u.rows.forEach(function(e){t=e.doc,key=t._id.split("|"),t.ref=key[1],r.push(t)}),n.load_array(r),r.length=0,n.pouch_db.query(e,a,s)):i():l&&o(l)}n.pouch_db.query(e,a,s)})}},pouch_db:{get:function(){const e=this.cachable.replace("_ram","");return-1!=e.indexOf("remote")?K.wsql.pouch.remote[e.replace("_remote","")]:K.wsql.pouch.local[e]||K.wsql.pouch.remote[e]}},pouch_find_rows:{value:function(e){var t,n,r,a,i,o,s=this,l=[],u=0,_=0,c=0,f={limit:100,include_docs:!0,startkey:s.class_name+"|",endkey:s.class_name+"|￰"};return e&&(e._top?(i=e._top,delete e._top):i=300,e._raw&&(n=e._raw,delete e._raw),e._total_count&&(a=e._total_count,delete e._total_count),e._view&&(r=e._view,delete e._view),e._key&&("des"==e._key._order_by?(f.startkey=e._key.endkey||e._key+"￰",f.endkey=e._key.startkey||e._key,f.descending=!0):(f.startkey=e._key.startkey||e._key,f.endkey=e._key.endkey||e._key+"￰")),"number"==typeof e._skip&&(_=e._skip,delete e._skip),e._attachments&&(f.attachments=!0,f.binary=!0,delete e._attachments)),a&&(o=!0,a=0,Object.keys(e).length<=1&&e._key&&e._key.hasOwnProperty("_search"))?(f.include_docs=!1,f.limit=1e5,s.pouch_db.query(r,f).then(function(t){return t.rows.forEach(function(t){if(!e._key._search||-1!=t.key[t.key.length-1].toLowerCase().indexOf(e._key._search)){if(a++,_&&++c<_)return;if(i&&++u>i)return;l.push(t.id)}}),delete f.startkey,delete f.endkey,f.descending&&delete f.descending,f.keys=l,f.include_docs=!0,s.pouch_db.allDocs(f)}).then(function(e){return{rows:e.rows.map(function(e){var t=e.doc;return t.ref=t._id.split("|")[1],n||(delete t._id,delete t._rev),t}),_total_count:a}})):new Promise(function(d,p){function h(r,h){h?h.rows.length?(f.startkey=h.rows[h.rows.length-1].key,f.skip=1,h.rows.forEach(function(r){t=r.doc,key=t._id.split("|"),t.ref=key[1],n||(delete t._id,delete t._rev),K._selection.call(s,t,e)&&(o&&a++,_&&++c<_||i&&++u>i||l.push(t))}),i&&u>i&&!o?d(n?l:s.load_array(l)):m()):d(o?{rows:n?l:s.load_array(l),_total_count:a}:n?l:s.load_array(l)):r&&p(r)}function m(){r?s.pouch_db.query(r,f,h):s.pouch_db.allDocs(f,h)}m()})}},pouch_selection:{value:function(e){var t,n,r,a=this,i=e.metadata||a.metadata(),o=["ref","_deleted"],s={_raw:!0,_total_count:!0,_top:e.count||30,_skip:e.start||0},l=[];if(i.form&&i.form.selection?i.form.selection.fields.forEach(function(e){o.push(e)}):a instanceof y?(o.push("posted"),o.push("date"),o.push("number_doc")):a instanceof g?(o.push("name as presentation"),o.push("date"),o.push("number_doc"),o.push("completed")):a instanceof b?(o.push("date"),o.push("number_doc"),o.push("started"),o.push("finished")):(i.hierarchical&&i.group_hierarchy?o.push("is_folder"):o.push("0 as is_folder"),i.main_presentation_name?o.push("name as presentation"):i.code_length?o.push("id as presentation"):o.push("'...' as presentation"),i.has_owners&&o.push("owner"),i.code_length&&o.push("id")),Y.get(a.class_name,"date")&&(e.date_from||e.date_till)&&(e.date_from||(e.date_from=new Date("2015-01-01")),e.date_till||(e.date_till=K.utils.date_add_day(new Date,1)),s.date={between:[e.date_from,e.date_till]}),i.hierarchical&&e.parent&&(s.parent=e.parent),e.selection)if(Array.isArray(e.selection))e.selection.forEach(function(e){for(r in e)"_"==r[0]&&"_view"!=r&&"_key"!=r||(s[r]=e[r])});else for(r in e.selection)"_"==r[0]&&"_view"!=r&&"_key"!=r||(s[r]=e.selection[r]);return s._key&&s._key._drop_date&&s.date&&delete s.date,!e.filter||s._key&&s._key._search||(1==i.input_by_string.length?s[i.input_by_string]={like:e.filter}:(s.or=[],i.input_by_string.forEach(function(t){var n={};n[t]={like:e.filter},s.or.push(n)}))),s._key&&s._key._order_by&&(s._key._order_by=e.direction),a.pouch_find_rows(s).then(function(i){return i.hasOwnProperty("_total_count")&&i.hasOwnProperty("rows")&&(e._total_count=i._total_count,i=i.rows),i.forEach(function(e){t={},o.forEach(function(i){if("ref"==i)return void(t[i]=e[i]);if(-1!=i.indexOf(" as ")?(r=i.split(" as ")[1],i=i.split(" as ")[0].split("."),i=i[i.length-1]):r=i,n=Y.get(a.class_name,i))if(n.type.date_part)t[r]=K.moment(e[i]).format(K.moment._masks[n.type.date_part]);else if(n.type.is_ref)if(e[i]&&e[i]!=K.utils.blank.guid){var o=Y.value_mgr(t,i,n.type,!1,e[i]);t[r]=o?o.get(e[i]).presentation:""}else t[r]="";else"number"==typeof e[i]&&n.type.fraction_figits?t[r]=e[i].toFixed(n.type.fraction_figits):t[r]=e[i]}),l.push(t)}),K.iface.data_to_grid.call(a,l,e)}).catch(K.record_log)}},pouch_tree:{value:function(e){return this.pouch_find_rows({is_folder:!0,_raw:!0,_top:e.count||300,_skip:e.start||0}).then(function(e){return e.sort(function(e,t){return e.parent==K.utils.blank.guid&&t.parent!=K.utils.blank.guid?-1:t.parent==K.utils.blank.guid&&e.parent!=K.utils.blank.guid?1:e.name<t.name?-1:e.name>t.name?1:0}),e.map(function(e){return{ref:e.ref,parent:e.parent,presentation:e.name}})}).then(K.iface.data_to_tree)}},save_attachment:{value:function(e,t,n,r){r||(r={type:"text/plain"}),n instanceof Blob||-1!=r.indexOf("text")||(n=new Blob([n],{type:r}));var a,i=this.pouch_db;return e=this.class_name+"|"+K.utils.fix_guid(e),i.get(e).then(function(e){e&&(a=e._rev)}).catch(function(e){if(404!=e.status)throw e}).then(function(){return i.putAttachment(e,t,a,n,r)})}},get_attachment:{value:function(e,t){return this.pouch_db.getAttachment(this.class_name+"|"+K.utils.fix_guid(e),t)}},delete_attachment:{value:function(e,t){var n,r=this.pouch_db;return e=this.class_name+"|"+K.utils.fix_guid(e),r.get(e).then(function(e){e&&(n=e._rev)}).catch(function(e){if(404!=e.status)throw e}).then(function(){return r.removeAttachment(e,t,n)})}}}),E.prototype.__define({new_number_doc:{value:function(e){if(this._metadata.code_length){e||(e=(K.current_user&&K.current_user.prefix||"")+(this.organization&&this.organization.prefix||""));var t=this,n="",r=this.date instanceof Date?this.date.getFullYear():0,a=this._metadata.code_length-e.length;return"ram"==this._manager.cachable?Promise.resolve(this.new_cat_id(e)):t._manager.pouch_db.query("doc/number_doc",{limit:1,include_docs:!1,startkey:[t.class_name,r,e+"￰"],endkey:[t.class_name,r,e],descending:!0}).then(function(r){if(r.rows.length){for(var i=r.rows[0].key[2],o=i.length-1;o>0&&!isNaN(parseInt(i[o]));o--)n=i[o]+n;n=(parseInt(n||0)+1).toFixed(0)}else n="1";for(;n.length<a;)n="0"+n;return t instanceof A||t instanceof R||t instanceof S?t.number_doc=e+n:t.id=e+n,t})}}},new_cat_id:{value:function(e){e||(e=(K.current_user&&K.current_user.prefix||"")+(this.organization&&this.organization.prefix?this.organization.prefix:K.wsql.get_user_param("zone")+"-"));var t=this._metadata.code_length-e.length,n=this instanceof A||this instanceof R||this instanceof S?"number_doc":"id",r="",a=K.wsql.alasql("select top 1 "+n+" as id from ? where "+n+" like '"+e+"%' order by "+n+" desc",[this._manager.alatable]);if(a.length){for(var i=a[0].id||"",o=i.length-1;o>0&&!isNaN(parseInt(i[o]));o--)r=i[o]+r;r=(parseInt(r||0)+1).toFixed(0)}else r="1";for(;r.length<t;)r="0"+r;return this[n]=e+r,this}}}),L.prototype.__define({base_url:{value:function(){return K.wsql.get_user_param("rest_path")||K.job_prm.rest_path||"/a/zd/%1/odata/standard.odata/"}},parse_url_str:{value:function(e){var t,n={},r=[];if("#"!==e[0]&&"?"!==e[0]||(e=e.substr(1)),e.length>2){t=decodeURI(e).split("&");for(var a in t)if(r=t[a].split("="),"m"==r[0])try{n[r[0]]=JSON.parse(r[1])}catch(e){n[r[0]]={}}else n[r[0]]=r[1]||""}return n}},parse_url:{value:function(){return this.parse_url_str(location.search)._mixin(this.parse_url_str(location.hash))}},rest_url:{value:function(){var e=this.base_url(),t=K.wsql.get_user_param("zone",K.job_prm.zone_is_string?"string":"number");return t?e.replace("%1",t):e.replace("%1/","")}},irest_url:{value:function(){var e=this.base_url().replace("odata/standard.odata","hs/rest"),t=K.wsql.get_user_param("zone",K.job_prm.zone_is_string?"string":"number");return t?e.replace("%1",t):e.replace("%1/","")}}}),"undefined"!=typeof module&&module.exports&&(module.exports=I),K});